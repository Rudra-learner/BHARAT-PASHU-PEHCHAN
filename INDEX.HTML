<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pashu Pehchan - Authorities Dashboard</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Inter font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Leaflet.js CSS for Interactive Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* A light grey background */
        }
        .sidebar {
            transition: transform 0.3s ease-in-out;
        }
        .main-content {
            transition: margin-left 0.3s ease-in-out;
        }
        .sidebar-closed {
            transform: translateX(-100%);
        }
        .main-content-expanded {
            margin-left: 0;
        }
        @media (min-width: 1024px) {
            .main-content-expanded {
                margin-left: 16rem; /* Default sidebar width */
            }
        }
        /* Leaflet map container style */
        #map, #geospatialMap {
            height: 100%;
            width: 100%;
            border-radius: 0.5rem; /* rounded-lg */
            z-index: 10;
        }
        /* Style for active nav link */
        .nav-link.active {
            background-color: #4a5568; /* bg-gray-700 */
        }
        .nav-link.active .fa-solid,
        .nav-link.active i {
             color: #2dd4bf; /* text-cyan-400 */
        }
        /* Custom searchable dropdown */
        .searchable-dropdown-list {
            max-height: 200px;
            overflow-y: auto;
        }
        /* Toggle switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #06b6d4;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #06b6d4;
        }
         /* Full screen loader */
        #app-loader {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Full App Loader -->
    <div id="app-loader" class="fixed inset-0 z-50 flex flex-col items-center justify-center">
        <i class="fas fa-paw text-5xl text-cyan-600 animate-bounce"></i>
        <p class="mt-4 text-lg font-semibold text-gray-700">Initializing Pashu Pehchan...</p>
        <p class="text-sm text-gray-500">Connecting to the secure database.</p>
    </div>


    <!-- Sidebar Navigation -->
    <aside id="sidebar" class="bg-gray-800 text-white w-64 fixed inset-y-0 left-0 z-40 transform lg:transform-none transition-transform duration-300 ease-in-out">
        <div class="p-5 border-b border-gray-700 flex items-center">
            <i class="fas fa-paw text-2xl mr-3 text-cyan-400"></i>
            <h1 class="text-xl font-bold">Pashu Pehchan</h1>
        </div>
        <nav class="mt-5" id="navigation-menu">
            <a href="#dashboard" class="nav-link flex items-center px-6 py-3 text-gray-300 hover:bg-gray-700 active">
                <i class="fas fa-tachometer-alt w-6"></i>
                <span class="ml-4">Dashboard</span>
            </a>
            <a href="#geospatial" class="nav-link flex items-center px-6 py-3 text-gray-300 hover:bg-gray-700">
                <i class="fas fa-map-marked-alt w-6"></i>
                <span class="ml-4">Geospatial Map</span>
            </a>
            <a href="#reports" class="nav-link flex items-center px-6 py-3 text-gray-300 hover:bg-gray-700">
                <i class="fas fa-chart-bar w-6"></i>
                <span class="ml-4">Reports</span>
            </a>
            <a href="#workers" class="nav-link flex items-center px-6 py-3 text-gray-300 hover:bg-gray-700">
                <i class="fas fa-users w-6"></i>
                <span class="ml-4">Field Workers</span>
            </a>
            <a href="#settings" class="nav-link flex items-center px-6 py-3 text-gray-300 hover:bg-gray-700">
                <i class="fas fa-cog w-6"></i>
                <span class="ml-4">Settings</span>
            </a>
        </nav>
        <div class="absolute bottom-0 w-full p-6">
            <a href="#" class="flex items-center text-gray-400 hover:text-white">
                <i class="fas fa-sign-out-alt w-6"></i>
                <span class="ml-4">Logout</span>
            </a>
        </div>
    </aside>

    <!-- Main Content Area -->
    <div id="main-content" class="ml-0 lg:ml-64 p-6 md:p-8 transition-all duration-300 ease-in-out">
        
        <!-- View: Dashboard -->
        <main id="dashboard-view" class="view">
            <!-- Header -->
            <header class="flex justify-between items-center mb-8">
                <div>
                    <button id="menu-btn" class="lg:hidden text-gray-600">
                        <i class="fas fa-bars text-2xl"></i>
                    </button>
                    <h2 class="text-3xl font-bold text-gray-800 hidden md:block">Welcome, Administrator</h2>
                    <p class="text-gray-500 hidden md:block">Here's the real-time overview of animal registration and breed data.</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <input type="text" placeholder="Search Animal ID..." class="bg-white border border-gray-300 rounded-full py-2 px-4 pl-10 focus:outline-none focus:ring-2 focus:ring-cyan-500 w-32 sm:w-64">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <button class="relative text-gray-600">
                        <i class="fas fa-bell text-xl"></i>
                        <span class="absolute top-0 right-0 h-2 w-2 bg-red-500 rounded-full"></span>
                    </button>
                    <div>
                        <img src="https://placehold.co/40x40/E2E8F0/4A5568?text=A" alt="Admin" class="w-10 h-10 rounded-full">
                    </div>
                </div>
            </header>

            <!-- Key Metrics Cards -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-2xl shadow-md flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Total Animals Registered</p>
                        <p id="total-animals-count" class="text-3xl font-bold text-gray-800">0</p>
                    </div>
                    <div class="bg-cyan-100 text-cyan-600 p-4 rounded-full">
                        <i class="fas fa-hippo text-2xl"></i>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-md flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Cattle Registered</p>
                        <p id="cattle-count" class="text-3xl font-bold text-gray-800">0</p>
                    </div>
                    <div class="bg-orange-100 text-orange-600 p-4 rounded-full">
                        <i class="fas fa-cow text-2xl"></i>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-md flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Buffaloes Registered</p>
                        <p id="buffalo-count" class="text-3xl font-bold text-gray-800">0</p>
                    </div>
                    <div class="bg-indigo-100 text-indigo-600 p-4 rounded-full">
                         <i class="fas fa-water text-2xl"></i>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-md flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">AI Accuracy</p>
                        <p id="ai-accuracy" class="text-3xl font-bold text-gray-800">0%</p>
                        <p class="text-gray-500 text-sm mt-1">vs Manual Entries</p>
                    </div>
                    <div class="bg-emerald-100 text-emerald-600 p-4 rounded-full">
                        <i class="fas fa-robot text-2xl"></i>
                    </div>
                </div>
            </div>

            <!-- Charts and Map Section -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                <!-- Breed Distribution Chart -->
                <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-md flex flex-col">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Breed Distribution</h3>
                    <div class="relative" style="height: 320px;">
                        <div id="chart-loader" class="absolute inset-0 flex items-center justify-center z-10">
                            <i class="fas fa-spinner fa-spin text-4xl text-cyan-600"></i>
                        </div>
                        <canvas id="breedChart"></canvas>
                    </div>
                </div>
                <!-- Geospatial Distribution Map -->
                <div class="bg-white p-6 rounded-2xl shadow-md flex flex-col">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Geospatial Distribution</h3>
                    <div class="flex-grow h-64 md:h-auto">
                         <div id="map"></div>
                    </div>
                </div>
            </div>

            <!-- Recent Registrations Table -->
            <div class="bg-white p-6 rounded-2xl shadow-md">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Recent Registrations</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="text-sm font-semibold text-gray-500 border-b">
                                <th class="p-4">Animal ID</th>
                                <th class="p-4">Breed (AI Suggestion)</th>
                                <th class="p-4">Confidence</th>
                                <th class="p-4">Location</th>
                                <th class="p-4">Field Worker</th>
                                <th class="p-4">Timestamp</th>
                                <th class="p-4">Status</th>
                            </tr>
                        </thead>
                        <tbody id="recent-registrations-body" class="text-gray-700">
                           <!-- Rows will be dynamically inserted here -->
                           <tr><td colspan="7" class="text-center p-8 text-gray-500">Loading registrations...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>

        <!-- View: Geospatial Report -->
        <main id="geospatial-view" class="view hidden">
             <header class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800">Geospatial Report</h2>
                    <p class="text-gray-500">Filter and analyze breed distribution by region.</p>
                </div>
            </header>
            
            <!-- Filter Section -->
            <div class="bg-white p-6 rounded-2xl shadow-md mb-8">
                 <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6 items-end">
                    <!-- Custom Searchable Dropdown for State -->
                    <div class="relative" id="state-dropdown-container">
                        <label for="state-search" class="block text-sm font-medium text-gray-700 mb-1">State</label>
                        <div class="relative">
                            <input type="text" id="state-search" placeholder="Select State" class="w-full p-2 border border-gray-300 rounded-md focus:ring-cyan-500 focus:border-cyan-500" autocomplete="off">
                            <i class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                        </div>
                        <div id="state-list" class="searchable-dropdown-list absolute hidden w-full bg-white border border-gray-300 rounded-md mt-1 z-20">
                            <!-- State options will be populated by JS -->
                        </div>
                    </div>
                    
                    <!-- Custom Searchable Dropdown for District -->
                    <div class="relative" id="district-dropdown-container">
                        <label for="district-search" class="block text-sm font-medium text-gray-700 mb-1">District</label>
                         <div class="relative">
                            <input type="text" id="district-search" placeholder="Select District" class="w-full p-2 border border-gray-300 rounded-md focus:ring-cyan-500 focus:border-cyan-500" autocomplete="off" disabled>
                            <i class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                        </div>
                        <div id="district-list" class="searchable-dropdown-list absolute hidden w-full bg-white border border-gray-300 rounded-md mt-1 z-20">
                           <!-- District options will be populated by JS -->
                        </div>
                    </div>
                    
                    <div class="md:col-start-3 lg:col-start-4">
                        <button id="filter-btn" class="w-full bg-cyan-600 text-white font-bold py-2 px-4 rounded-md hover:bg-cyan-700 transition-colors">
                            Apply Filter
                        </button>
                    </div>
                </div>
            </div>

            <!-- Data Summary Section -->
            <div id="geospatial-summary" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-2xl shadow-md">
                    <p class="text-gray-500 text-sm font-medium">Total Registrations in Area</p>
                    <p id="summary-total" class="text-3xl font-bold text-gray-800">---</p>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-md">
                    <p class="text-gray-500 text-sm font-medium">Most Common Breed</p>
                    <p id="summary-breed" class="text-3xl font-bold text-gray-800">---</p>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-md">
                    <p class="text-gray-500 text-sm font-medium">Latest Registration</p>
                    <p id="summary-date" class="text-3xl font-bold text-gray-800">---</p>
                </div>
            </div>

            <!-- Map Display -->
            <div class="bg-white p-6 rounded-2xl shadow-md">
                <div class="h-96 md:h-[600px] w-full">
                    <div id="geospatialMap"></div>
                </div>
            </div>
        </main>
        
        <!-- View: Reports -->
        <main id="reports-view" class="view hidden">
            <header class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800">Generate Custom Reports</h2>
                    <p class="text-gray-500">Select your criteria to generate a downloadable report.</p>
                </div>
            </header>

            <div class="bg-white p-8 rounded-2xl shadow-md">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 items-end">
                    <!-- Report Type -->
                    <div>
                        <label for="report-type" class="block text-sm font-medium text-gray-700 mb-1">Report Type</label>
                        <select id="report-type" class="w-full p-2 border border-gray-300 rounded-md focus:ring-cyan-500 focus:border-cyan-500">
                            <option>Breed Distribution Census</option>
                            <option>AI Model Accuracy Analysis</option>
                            <option>Field Worker Activity Log</option>
                        </select>
                    </div>

                    <!-- Date Range -->
                    <div>
                        <label for="report-daterange" class="block text-sm font-medium text-gray-700 mb-1">Date Range</label>
                        <select id="report-daterange" class="w-full p-2 border border-gray-300 rounded-md focus:ring-cyan-500 focus:border-cyan-500">
                            <option>Last 30 Days</option>
                            <option>Last 90 Days</option>
                            <option>This Year</option>
                            <option>All Time</option>
                        </select>
                    </div>
                    
                    <!-- Export Format -->
                    <div>
                        <label for="report-format" class="block text-sm font-medium text-gray-700 mb-1">Export Format</label>
                        <select id="report-format" class="w-full p-2 border border-gray-300 rounded-md focus:ring-cyan-500 focus:border-cyan-500">
                            <option>PDF</option>
                            <option>CSV (Excel)</option>
                        </select>
                    </div>

                    <!-- Location Filters -->
                    <div class="relative md:col-span-2 lg:col-span-3 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div id="report-state-container">
                            <label for="report-state-search" class="block text-sm font-medium text-gray-700 mb-1">State (Optional)</label>
                            <div class="relative">
                                <input type="text" id="report-state-search" placeholder="All States" class="w-full p-2 border border-gray-300 rounded-md focus:ring-cyan-500 focus:border-cyan-500" autocomplete="off">
                                <i class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                            </div>
                            <div id="report-state-list" class="searchable-dropdown-list absolute hidden w-full bg-white border border-gray-300 rounded-md mt-1 z-20"></div>
                        </div>
                        <div id="report-district-container">
                            <label for="report-district-search" class="block text-sm font-medium text-gray-700 mb-1">District (Optional)</label>
                             <div class="relative">
                                <input type="text" id="report-district-search" placeholder="All Districts" class="w-full p-2 border border-gray-300 rounded-md focus:ring-cyan-500 focus:border-cyan-500" autocomplete="off" disabled>
                                <i class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                            </div>
                            <div id="report-district-list" class="searchable-dropdown-list absolute hidden w-full bg-white border border-gray-300 rounded-md mt-1 z-20"></div>
                        </div>
                    </div>
                    
                    <!-- Generate Button -->
                    <div class="lg:col-start-3">
                         <button id="generate-report-btn" class="w-full bg-cyan-600 text-white font-bold py-2 px-4 rounded-md hover:bg-cyan-700 transition-colors flex items-center justify-center">
                            <i class="fas fa-cogs mr-2"></i> Generate Report
                        </button>
                    </div>
                </div>
            </div>

            <!-- Report Status Section -->
            <div id="report-status" class="mt-8 text-center hidden">
                <div class="bg-white p-8 rounded-2xl shadow-md inline-block">
                    <div id="report-spinner" class="mb-4">
                        <i class="fas fa-spinner fa-spin text-4xl text-cyan-600"></i>
                        <p class="mt-2 text-gray-600 font-medium">Generating your report, please wait...</p>
                    </div>
                    <div id="report-success" class="hidden">
                         <i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i>
                         <h3 id="report-success-title" class="text-xl font-bold text-gray-800">Report Generated!</h3>
                         <p id="report-success-message" class="text-gray-600 mt-2 mb-4"></p>
                         <a href="#" download="report.pdf" id="download-report-link" class="bg-green-500 text-white font-bold py-2 px-6 rounded-md hover:bg-green-600 transition-colors inline-flex items-center">
                            <i class="fas fa-download mr-2"></i> Download
                         </a>
                    </div>
                </div>
            </div>

        </main>
        
        <!-- View: Field Workers -->
        <main id="workers-view" class="view hidden">
            <header class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800">Field Worker Management</h2>
                    <p class="text-gray-500">Monitor and manage your field personnel.</p>
                </div>
                <button id="add-worker-btn" class="bg-cyan-600 text-white font-bold py-2 px-4 rounded-md hover:bg-cyan-700 transition-colors flex items-center">
                    <i class="fas fa-plus mr-2"></i> Add New Worker
                </button>
            </header>
            
            <div class="bg-white p-6 rounded-2xl shadow-md">
                <h3 class="text-xl font-bold text-gray-800 mb-4">All Field Workers</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="text-sm font-semibold text-gray-500 border-b">
                                <th class="p-4">Worker ID</th>
                                <th class="p-4">Name</th>
                                <th class="p-4">Assigned Area</th>
                                <th class="p-4">Registrations</th>
                                <th class="p-4">Status</th>
                                <th class="p-4 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="worker-table-body" class="text-gray-700 divide-y">
                            <!-- Worker rows dynamically inserted here -->
                             <tr><td colspan="6" class="text-center p-8 text-gray-500">Loading worker data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
        <main id="settings-view" class="view hidden">
             <header class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800">Settings</h2>
                    <p class="text-gray-500">Manage your account and system preferences.</p>
                </div>
            </header>
            
            <div class="space-y-8">
                <!-- Account Settings -->
                <div class="bg-white p-8 rounded-2xl shadow-md">
                    <h3 class="text-xl font-bold text-gray-800 mb-6">Account Settings</h3>
                    <form class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="admin-name" class="block text-sm font-medium text-gray-700 mb-1">Admin Name</label>
                                <input type="text" id="admin-name" value="Administrator" class="w-full p-2 border border-gray-300 rounded-md focus:ring-cyan-500 focus:border-cyan-500">
                            </div>
                            <div>
                                <label for="admin-email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                                <input type="email" id="admin-email" value="admin@pashupehchan.gov.in" class="w-full p-2 border border-gray-300 rounded-md focus:ring-cyan-500 focus:border-cyan-500">
                            </div>
                        </div>
                        <div>
                            <button type="button" class="text-cyan-600 font-semibold hover:underline">Change Password</button>
                        </div>
                        <div class="pt-4 text-right">
                            <button type="submit" class="px-6 py-2 bg-cyan-600 text-white rounded-md hover:bg-cyan-700 transition-colors">Save Changes</button>
                        </div>
                    </form>
                </div>

                <!-- System Settings -->
                 <div class="bg-white p-8 rounded-2xl shadow-md">
                    <h3 class="text-xl font-bold text-gray-800 mb-6">System Settings</h3>
                    <div class="space-y-6">
                        <div>
                            <label for="ai-threshold" class="block text-sm font-medium text-gray-700 mb-1">AI Confidence Threshold</label>
                            <p class="text-xs text-gray-500 mb-2">Suggestions below this value will require mandatory manual review.</p>
                            <select id="ai-threshold" class="w-full md:w-1/3 p-2 border border-gray-300 rounded-md focus:ring-cyan-500 focus:border-cyan-500">
                                <option>80%</option>
                                <option selected>85%</option>
                                <option>90%</option>
                                <option>95%</option>
                            </select>
                        </div>
                         <div class="border-t pt-6">
                            <h4 class="text-md font-semibold text-gray-700">Data Management</h4>
                            <div class="flex items-center space-x-4 mt-4">
                                <button class="px-4 py-2 bg-gray-600 text-white text-sm rounded-md hover:bg-gray-700">
                                    <i class="fas fa-database mr-2"></i>Backup Database
                                </button>
                                <button class="px-4 py-2 bg-red-600 text-white text-sm rounded-md hover:bg-red-700">
                                    <i class="fas fa-archive mr-2"></i>Archive Old Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                 <!-- Notification Settings -->
                <div class="bg-white p-8 rounded-2xl shadow-md">
                    <h3 class="text-xl font-bold text-gray-800 mb-6">Notification Settings</h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="font-medium text-gray-700">Email Notifications</p>
                                <p class="text-sm text-gray-500">Receive weekly summary reports via email.</p>
                            </div>
                            <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="toggle" id="email-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" checked/>
                                <label for="email-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                        </div>
                         <div class="flex items-center justify-between">
                            <div>
                                <p class="font-medium text-gray-700">Push Notifications</p>
                                <p class="text-sm text-gray-500">Get alerts for critical system events on your devices.</p>
                            </div>
                            <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="toggle" id="push-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                <label for="push-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>

    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center flex">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-sm m-4">
            <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-4">Confirm Action</h3>
            <p id="modal-body" class="text-gray-600 mb-6">Are you sure you want to proceed?</p>
            <div class="flex justify-end space-x-4">
                <button id="modal-cancel-btn" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">Cancel</button>
                <button id="modal-confirm-btn" class="px-6 py-2 bg-cyan-600 text-white rounded-md hover:bg-cyan-700 transition-colors">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Edit Worker Modal -->
    <div id="edit-worker-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center flex">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-lg m-4">
            <h3 class="text-xl font-bold text-gray-800 mb-6">Edit Field Worker Details</h3>
            <form id="edit-worker-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="edit-worker-id" class="block text-sm font-medium text-gray-700 mb-1">Worker ID</label>
                        <input type="text" id="edit-worker-id" class="w-full p-2 bg-gray-100 border border-gray-300 rounded-md" readonly>
                    </div>
                    <div>
                        <label for="edit-worker-name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                        <input type="text" id="edit-worker-name" class="w-full p-2 border border-gray-300 rounded-md focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                    <!-- State Dropdown -->
                    <div class="relative" id="edit-state-container">
                        <label for="edit-state-search" class="block text-sm font-medium text-gray-700 mb-1">Assigned State</label>
                        <div class="relative">
                            <input type="text" id="edit-state-search" placeholder="Select State" class="w-full p-2 border border-gray-300 rounded-md focus:ring-cyan-500 focus:border-cyan-500" autocomplete="off">
                             <i class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                        </div>
                        <div id="edit-state-list" class="searchable-dropdown-list absolute hidden w-full bg-white border border-gray-300 rounded-md mt-1 z-30"></div>
                    </div>
                    <!-- District Dropdown -->
                    <div class="relative" id="edit-district-container">
                        <label for="edit-district-search" class="block text-sm font-medium text-gray-700 mb-1">Assigned District</label>
                         <div class="relative">
                            <input type="text" id="edit-district-search" placeholder="Select District" class="w-full p-2 border border-gray-300 rounded-md focus:ring-cyan-500 focus:border-cyan-500" autocomplete="off" disabled>
                             <i class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                        </div>
                        <div id="edit-district-list" class="searchable-dropdown-list absolute hidden w-full bg-white border border-gray-300 rounded-md mt-1 z-30"></div>
                    </div>
                </div>
                <div class="mt-8 flex justify-end space-x-4">
                    <button type="button" id="edit-modal-cancel-btn" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">Cancel</button>
                    <button type="submit" class="px-6 py-2 bg-cyan-600 text-white rounded-md hover:bg-cyan-700 transition-colors">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Worker Modal -->
    <div id="add-worker-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center flex">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-lg m-4">
            <h3 class="text-xl font-bold text-gray-800 mb-6">Add New Field Worker</h3>
            <form id="add-worker-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                     <div>
                        <label for="add-worker-name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                        <input type="text" id="add-worker-name" placeholder="Enter full name" class="w-full p-2 border border-gray-300 rounded-md focus:ring-cyan-500 focus:border-cyan-500" required>
                    </div>
                     <div>
                        <!-- Placeholder for alignment -->
                    </div>
                    <!-- State Dropdown -->
                    <div class="relative" id="add-state-container">
                        <label for="add-state-search" class="block text-sm font-medium text-gray-700 mb-1">Assigned State</label>
                        <div class="relative">
                            <input type="text" id="add-state-search" placeholder="Select State" class="w-full p-2 border border-gray-300 rounded-md focus:ring-cyan-500 focus:border-cyan-500" autocomplete="off" required>
                             <i class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                        </div>
                        <div id="add-state-list" class="searchable-dropdown-list absolute hidden w-full bg-white border border-gray-300 rounded-md mt-1 z-30"></div>
                    </div>
                    <!-- District Dropdown -->
                    <div class="relative" id="add-district-container">
                        <label for="add-district-search" class="block text-sm font-medium text-gray-700 mb-1">Assigned District</label>
                         <div class="relative">
                            <input type="text" id="add-district-search" placeholder="Select District" class="w-full p-2 border border-gray-300 rounded-md focus:ring-cyan-500 focus:border-cyan-500" autocomplete="off" disabled required>
                             <i class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                        </div>
                        <div id="add-district-list" class="searchable-dropdown-list absolute hidden w-full bg-white border border-gray-300 rounded-md mt-1 z-30"></div>
                    </div>
                </div>
                <div class="mt-8 flex justify-end space-x-4">
                    <button type="button" id="add-modal-cancel-btn" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">Cancel</button>
                    <button type="submit" class="px-6 py-2 bg-cyan-600 text-white rounded-md hover:bg-cyan-700 transition-colors">Add Worker</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Leaflet.js script -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getDatabase, ref, onValue, set, push, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // --- Firebase Initialization ---
        const firebaseConfig = {
            apiKey: "AIzaSyBtX3TT6oDoICuWSUvEzKPaJxHEk2-J-34",
            authDomain: "sih-win.firebaseapp.com",
            projectId: "sih-win",
            storageBucket: "sih-win.appspot.com",
            messagingSenderId: "225158149948",
            appId: "1:225158149948:web:cca547ed2f1d142f76d039",
            measurementId: "G-E0B3V5LKF0",
            databaseURL: "https://sih-win-default-rtdb.firebaseio.com/" // Correct URL for us-central1
        };
        
        const appId = 'pashu-pehchan-dashboard'; // A unique identifier for this app's data

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // --- Global State ---
        let registrationsUnsubscribe = null;
        let workersUnsubscribe = null;
        let registrationsData = [];
        let workersData = new Map();


        document.addEventListener('DOMContentLoaded', function () {
            // --- Common Elements ---
            const menuBtn = document.getElementById('menu-btn');
            const sidebar = document.getElementById('sidebar');
            
            // --- SPA Navigation Logic ---
            const navLinks = document.querySelectorAll('.nav-link');
            const views = document.querySelectorAll('.view');
            
            function switchView(hash) {
                views.forEach(view => view.classList.add('hidden'));
                navLinks.forEach(link => link.classList.remove('active'));
                const activeView = document.getElementById(hash.substring(1) + '-view');
                const activeLink = document.querySelector(`.nav-link[href="${hash}"]`);
                if (activeView) activeView.classList.remove('hidden');
                if (activeLink) activeLink.classList.add('active');
            }
            
            navLinks.forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    window.location.hash = this.getAttribute('href');
                });
            });
            
            window.addEventListener('hashchange', () => switchView(window.location.hash || '#dashboard'));
            switchView(window.location.hash || '#dashboard');


            // --- Sidebar Toggle ---
            menuBtn.addEventListener('click', () => {
                sidebar.classList.toggle('sidebar-closed');
            });

            // --- Dashboard Specific Logic ---
            const chartLoader = document.getElementById('chart-loader');
            const breedChartCanvas = document.getElementById('breedChart');
            let breedChart;
            
            function initDashboard() {
                setTimeout(() => {
                    if (document.getElementById('map')._leaflet_id) return;
                    const map = L.map('map').setView([22.5937, 78.9629], 5);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                }, 100);

                if (breedChart) return;
                const ctx = breedChartCanvas.getContext('2d');
                breedChart = new Chart(ctx, { type: 'bar', data: { labels: [], datasets: [{ label: 'Number of Animals', data: [], backgroundColor: [], borderColor: [], borderWidth: 1, borderRadius: 5 }] }, options: { animation: { duration: 500 }, responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: '#e5e7eb' } }, x: { grid: { display: false } } } } });
            }
            
            function updateDashboardUI(data) {
                // Metrics
                const total = data.length;
                const cattle = data.filter(r => r.type === 'Cattle').length;
                const buffalo = data.filter(r => r.type === 'Buffalo').length;
                const verified = data.filter(r => r.status === 'Verified').length;

                document.getElementById('total-animals-count').textContent = total.toLocaleString('en-IN');
                document.getElementById('cattle-count').textContent = cattle.toLocaleString('en-IN');
                document.getElementById('buffalo-count').textContent = buffalo.toLocaleString('en-IN');
                document.getElementById('ai-accuracy').textContent = total > 0 ? `${((verified / total) * 100).toFixed(1)}%` : '0%';

                // Breed Chart
                const breedCounts = data.reduce((acc, reg) => {
                    acc[reg.breed] = (acc[reg.breed] || 0) + 1;
                    return acc;
                }, {});
                const sortedBreeds = Object.entries(breedCounts).sort(([,a],[,b]) => b-a).slice(0, 10);
                const chartLabels = sortedBreeds.map(([breed]) => breed);
                const chartData = sortedBreeds.map(([,count]) => count);
                const colors = ['rgba(22, 163, 163, 0.7)', 'rgba(234, 88, 12, 0.7)', 'rgba(220, 38, 38, 0.7)', 'rgba(79, 70, 229, 0.7)', 'rgba(147, 51, 234, 0.7)', 'rgba(217, 119, 6, 0.7)', 'rgba(5, 150, 105, 0.7)', 'rgba(59, 130, 246, 0.7)', 'rgba(139, 92, 246, 0.7)', 'rgba(236, 72, 153, 0.7)'];
                
                if (breedChart) {
                    chartLoader.style.display = 'none';
                    breedChart.data.labels = chartLabels;
                    breedChart.data.datasets[0].data = chartData;
                    breedChart.data.datasets[0].backgroundColor = colors.slice(0, chartLabels.length);
                    breedChart.update();
                }

                // Recent Registrations Table
                const tableBody = document.getElementById('recent-registrations-body');
                tableBody.innerHTML = '';
                const recent = data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0, 5);
                if (recent.length === 0) {
                     tableBody.innerHTML = '<tr><td colspan="7" class="text-center p-8 text-gray-500">No registrations found.</td></tr>';
                } else {
                    recent.forEach(reg => {
                        const statusClass = reg.status === 'Verified' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700';
                        const confidenceClass = reg.confidence > 95 ? 'text-green-600' : 'text-orange-600';
                        const workerName = workersData.get(reg.workerId)?.name || 'Unknown';
                        const row = `
                            <tr>
                                <td class="p-4 font-medium">${reg.animalId}</td>
                                <td class="p-4">${reg.breed}</td>
                                <td class="p-4 ${confidenceClass}">${reg.confidence.toFixed(1)}%</td>
                                <td class="p-4">${reg.location}</td>
                                <td class="p-4">${workerName}</td>
                                <td class="p-4">${new Date(reg.timestamp).toLocaleString()}</td>
                                <td class="p-4"><span class="${statusClass} py-1 px-3 rounded-full text-xs font-semibold">${reg.status}</span></td>
                            </tr>
                        `;
                        tableBody.innerHTML += row;
                    });
                }
            }

            // --- Geospatial View Specific Logic ---
            let geospatialMap;
            
            function initGeospatialView() {
                setupSearchableDropdown('state', Object.keys(locationData), 'geospatial');
                setupSearchableDropdown('district', [], 'geospatial');
                document.getElementById('filter-btn').addEventListener('click', applyMapFilter);
                setTimeout(() => {
                    if (!geospatialMap) {
                         geospatialMap = L.map('geospatialMap').setView([22.5937, 78.9629], 5);
                         L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(geospatialMap);
                    }
                }, 100);
            }

            let mapMarkers = [];
            function applyMapFilter() {
                const state = document.getElementById('state-search').value;
                const district = document.getElementById('district-search').value;
                mapMarkers.forEach(marker => geospatialMap.removeLayer(marker));
                mapMarkers = [];
                // Filtering logic will now use the global `registrationsData`
                const filteredData = registrationsData.filter(reg => {
                    if (district && state) return reg.location.includes(district) && reg.location.includes(state);
                    if (state) return reg.location.includes(state);
                    return true;
                });
                
                const markerCoords = [];
                const locationCounts = filteredData.reduce((acc, reg) => {
                    const key = `${reg.location}-${reg.breed}`;
                    if(!acc[key]) acc[key] = { count: 0, lat: reg.lat, lng: reg.lng, breed: reg.breed };
                    acc[key].count++;
                    return acc;
                }, {});

                Object.values(locationCounts).forEach(d => {
                     const marker = L.marker([d.lat, d.lng]).addTo(geospatialMap).bindPopup(`<b>${d.breed}</b><br>${d.count.toLocaleString('en-IN')} registered.`);
                    mapMarkers.push(marker);
                    markerCoords.push([d.lat, d.lng]);
                });

                if (markerCoords.length > 1) geospatialMap.fitBounds(L.latLngBounds(markerCoords).pad(0.2));
                else if (markerCoords.length === 1) geospatialMap.setView(markerCoords[0], 13);
                // Summary section update... (Can be enhanced)
            }
            
            // --- Reports View Specific Logic ---
            function initReportsView() {
                setupSearchableDropdown('state', Object.keys(locationData), 'report');
                setupSearchableDropdown('district', [], 'report');
                document.getElementById('generate-report-btn').addEventListener('click', generateReport);
            }

            function generateReport() {
                const reportStatus = document.getElementById('report-status');
                reportStatus.classList.remove('hidden');
                document.getElementById('report-spinner').classList.remove('hidden');
                document.getElementById('report-success').classList.add('hidden');
                setTimeout(() => {
                    document.getElementById('report-spinner').classList.add('hidden');
                    document.getElementById('report-success').classList.remove('hidden');
                }, 2000);
            }

            // --- Field Workers View Specific Logic ---
            const confirmationModal = document.getElementById('confirmation-modal');
            const editWorkerModal = document.getElementById('edit-worker-modal');
            const editWorkerForm = document.getElementById('edit-worker-form');
            const addWorkerModal = document.getElementById('add-worker-modal');
            const addWorkerForm = document.getElementById('add-worker-form');
            const addWorkerBtn = document.getElementById('add-worker-btn');
            let currentEditingWorkerId = null;

            function initWorkersView() {
                addWorkerBtn.addEventListener('click', openAddModal);
                document.getElementById('modal-cancel-btn').addEventListener('click', () => confirmationModal.classList.add('hidden'));
                document.getElementById('edit-modal-cancel-btn').addEventListener('click', () => editWorkerModal.classList.add('hidden'));
                document.getElementById('add-modal-cancel-btn').addEventListener('click', () => addWorkerModal.classList.add('hidden'));
                addWorkerForm.addEventListener('submit', saveNewWorker);
                editWorkerForm.addEventListener('submit', saveWorkerChanges);
            }

            function updateWorkersUI(workersMap) {
                const tableBody = document.getElementById('worker-table-body');
                tableBody.innerHTML = '';
                if (workersMap.size === 0) {
                     tableBody.innerHTML = '<tr><td colspan="6" class="text-center p-8 text-gray-500">No field workers found.</td></tr>';
                     return;
                }
                workersMap.forEach((worker, id) => {
                    const row = tableBody.insertRow();
                    row.dataset.id = id;
                    const statusActive = worker.status === 'Active';
                    row.innerHTML = `
                        <td class="p-4 font-medium">${worker.workerId}</td>
                        <td class="p-4">${worker.name}</td>
                        <td class="p-4">${worker.assignedArea}</td>
                        <td class="p-4">${worker.registrations.toLocaleString('en-IN')}</td>
                        <td class="p-4 status-cell"><span class="py-1 px-3 rounded-full text-xs font-semibold ${statusActive ? 'bg-green-100 text-green-700' : 'bg-gray-200 text-gray-700'}">${worker.status}</span></td>
                        <td class="p-4 text-center space-x-2 action-cell">
                            <button class="text-blue-500 hover:text-blue-700" title="Edit Worker"><i class="fas fa-edit"></i></button>
                            <button class="${statusActive ? 'text-red-500 hover:text-red-700' : 'text-green-500 hover:text-green-700'}" title="${statusActive ? 'Deactivate' : 'Activate'} Worker"><i class="fas ${statusActive ? 'fa-user-slash' : 'fa-user-check'}"></i></button>
                        </td>
                    `;
                });
                tableBody.querySelectorAll('.action-cell button').forEach(btn => btn.addEventListener('click', handleWorkerAction));
            }
            
            async function openAddModal() {
                addWorkerForm.reset();
                setupSearchableDropdown('state', Object.keys(locationData), 'add');
                setupSearchableDropdown('district', [], 'add');
                document.getElementById('add-district-search').disabled = true;
                addWorkerModal.classList.remove('hidden');
            }

            async function saveNewWorker(e) {
                e.preventDefault();
                const name = document.getElementById('add-worker-name').value;
                const state = document.getElementById('add-state-search').value;
                const district = document.getElementById('add-district-search').value;
                const workerId = `FW-${Date.now().toString().slice(-4)}`;
                
                try {
                    const workersRef = ref(db, `artifacts/${appId}/public/data/workers`);
                    const newWorkerRef = push(workersRef);
                    await set(newWorkerRef, {
                        workerId, name, status: 'Active',
                        assignedArea: `${district}, ${state}`,
                        registrations: 0
                    });
                    addWorkerModal.classList.add('hidden');
                } catch (error) {
                    console.error("Error adding worker: ", error);
                    alert('Failed to add worker.');
                }
            }

            function handleWorkerAction(event) {
                const button = event.currentTarget;
                const row = button.closest('tr');
                const workerId = row.dataset.id;
                const worker = workersData.get(workerId);
                let action = '';
                if (button.title.includes('Edit')) action = 'edit';
                else if (button.title.includes('Deactivate')) action = 'deactivate';
                else if (button.title.includes('Activate')) action = 'activate';

                if (action === 'edit') openEditModal(worker, workerId);
                else showConfirmationModal(action, worker.name, workerId);
            }
            
            function openEditModal(worker, id) {
                currentEditingWorkerId = id;
                const area = worker.assignedArea.split(', ');
                document.getElementById('edit-worker-id').value = worker.workerId;
                document.getElementById('edit-worker-name').value = worker.name;
                document.getElementById('edit-state-search').value = area[1];
                document.getElementById('edit-district-search').value = area[0];
                setupSearchableDropdown('state', Object.keys(locationData), 'edit');
                document.getElementById('edit-district-search').disabled = false;
                setupSearchableDropdown('district', locationData[area[1]]?.districts || [], 'edit');
                editWorkerModal.classList.remove('hidden');
            }

            async function saveWorkerChanges(e) {
                e.preventDefault();
                if (!currentEditingWorkerId) return;
                const workerRef = ref(db, `artifacts/${appId}/public/data/workers/${currentEditingWorkerId}`);
                try {
                    await update(workerRef, {
                        name: document.getElementById('edit-worker-name').value,
                        assignedArea: `${document.getElementById('edit-district-search').value}, ${document.getElementById('edit-state-search').value}`
                    });
                    editWorkerModal.classList.add('hidden');
                } catch(error) {
                    console.error("Error updating worker: ", error);
                    alert("Failed to update worker.");
                }
            }

            function showConfirmationModal(action, workerName, workerId) {
                confirmationModal.classList.remove('hidden');
                let message = action === 'deactivate' ? `Deactivate ${workerName}? Access will be revoked.` : `Activate ${workerName}? They will regain access.`;
                document.getElementById('modal-body').textContent = message;

                const confirmBtn = document.getElementById('modal-confirm-btn');
                const actionHandler = () => performStatusAction(action, workerId);
                confirmBtn.addEventListener('click', actionHandler, { once: true });
                document.getElementById('modal-cancel-btn').addEventListener('click', () => confirmBtn.removeEventListener('click', actionHandler), { once: true });
            }

            async function performStatusAction(action, workerId) {
                const newStatus = action === 'activate' ? 'Active' : 'Inactive';
                const workerRef = ref(db, `artifacts/${appId}/public/data/workers/${workerId}`);
                try {
                    await update(workerRef, { status: newStatus });
                    confirmationModal.classList.add('hidden');
                } catch (error) {
                    console.error("Error changing status: ", error);
                    alert('Failed to change worker status.');
                }
            }


            // --- Generic Searchable Dropdown Logic ---
            function getPrefix(context) { return { 'report': 'report-', 'edit': 'edit-', 'add': 'add-' }[context] || ''; }
            
            function setupSearchableDropdown(type, items, context) {
                const prefix = getPrefix(context);
                const searchInput = document.getElementById(`${prefix}${type}-search`);
                const listContainer = document.getElementById(`${prefix}${type}-list`);
                if (!searchInput || !listContainer) return;

                searchInput.addEventListener('focus', () => listContainer.classList.remove('hidden'));
                searchInput.addEventListener('input', () => filterList(type, items, context));

                listContainer.innerHTML = '';
                items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'p-2 hover:bg-gray-100 cursor-pointer';
                    div.textContent = item;
                    div.addEventListener('click', () => selectItem(type, item, context));
                    listContainer.appendChild(div);
                });
            }

            function filterList(type, originalItems, context) {
                const prefix = getPrefix(context);
                const searchTerm = document.getElementById(`${prefix}${type}-search`).value.toLowerCase();
                const listContainer = document.getElementById(`${prefix}${type}-list`);
                listContainer.innerHTML = '';
                originalItems.filter(item => item.toLowerCase().includes(searchTerm)).forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'p-2 hover:bg-gray-100 cursor-pointer';
                    div.textContent = item;
                    div.addEventListener('click', () => selectItem(type, item, context));
                    listContainer.appendChild(div);
                });
            }
            
            function selectItem(type, value, context) {
                const prefix = getPrefix(context);
                const searchInput = document.getElementById(`${prefix}${type}-search`);
                searchInput.value = value;
                document.getElementById(`${prefix}${type}-list`).classList.add('hidden');
                if (type === 'state') {
                    const districtSearch = document.getElementById(`${prefix}district-search`);
                    districtSearch.disabled = false;
                    districtSearch.value = '';
                    setupSearchableDropdown('district', locationData[value]?.districts || [], context);
                }
            }

            document.addEventListener('click', (e) => {
                ['geospatial', 'report', 'edit', 'add'].forEach(context => {
                    if (!e.target.closest(`#${getPrefix(context)}state-container`)) document.getElementById(`${getPrefix(context)}state-list`)?.classList.add('hidden');
                    if (!e.target.closest(`#${getPrefix(context)}district-container`)) document.getElementById(`${getPrefix(context)}district-list`)?.classList.add('hidden');
                });
            });

            // --- App Initialization & Firebase Auth ---
            onAuthStateChanged(auth, user => {
                if (user) {
                    setupRealtimeListeners();
                    document.getElementById('app-loader').classList.add('hidden');
                } else {
                    signInAnonymously(auth).catch(error => {
                        console.error("Anonymous sign-in failed:", error);
                        document.getElementById('app-loader').innerHTML = '<p class="text-red-500">Error: Could not connect to authentication service.</p>';
                    });
                }
            });

            function setupRealtimeListeners() {
                // Detach previous listeners if they exist
                if (registrationsUnsubscribe) registrationsUnsubscribe();
                if (workersUnsubscribe) workersUnsubscribe();
                
                const registrationsRef = ref(db, `artifacts/${appId}/public/data/registrations`);
                registrationsUnsubscribe = onValue(registrationsRef, (snapshot) => {
                    const data = snapshot.val() || {};
                    const hasData = Object.keys(data).length > 0;
                    if (!hasData) seedInitialData('registrations');

                    registrationsData = Object.keys(data).map(key => ({
                        id: key,
                        ...data[key],
                        timestamp: new Date(data[key].timestamp) // Ensure timestamp is a Date object
                    }));
                    updateDashboardUI(registrationsData);
                }, (error) => console.error("Error fetching registrations:", error));
                
                const workersRef = ref(db, `artifacts/${appId}/public/data/workers`);
                workersUnsubscribe = onValue(workersRef, (snapshot) => {
                    const data = snapshot.val() || {};
                    const hasData = Object.keys(data).length > 0;
                    if (!hasData) seedInitialData('workers');

                    workersData.clear();
                    Object.keys(data).forEach(key => workersData.set(key, { id: key, ...data[key] }));
                    updateWorkersUI(workersData);
                }, (error) => console.error("Error fetching workers:", error));
            }
            
            let seeding = { workers: false, registrations: false };
            async function seedInitialData(type) {
                if (seeding[type]) return;
                seeding[type] = true;
                console.log(`Seeding initial data for ${type}...`);
                const updates = {};
                
                try {
                    if(type === 'workers') {
                        const workersRefPath = `artifacts/${appId}/public/data/workers`;
                        const initialWorkers = [
                            { workerId: 'FW-1023', name: 'Ramesh Kumar', assignedArea: 'Anand, Gujarat', registrations: 1245, status: 'Active' },
                            { workerId: 'FW-1024', name: 'Sunita Devi', assignedArea: 'Rohtak, Haryana', registrations: 987, status: 'Active' }
                        ];
                        initialWorkers.forEach(worker => {
                            const newKey = push(ref(db, workersRefPath)).key;
                            updates[`${workersRefPath}/${newKey}`] = worker;
                        });
                    }
                    if(type === 'registrations') {
                        const regsRefPath = `artifacts/${appId}/public/data/registrations`;
                        const initialRegs = [
                            { animalId: '#Cattle-78A5B', breed: 'Gir', confidence: 98.2, location: 'Anand, Gujarat', lat: 22.5645, lng: 72.9289, status: 'Verified', timestamp: new Date().toISOString(), type: 'Cattle', workerId: 'initial' },
                            { animalId: '#Buffalo-92C4F', breed: 'Murrah', confidence: 95.1, location: 'Rohtak, Haryana', lat: 28.8955, lng: 76.6066, status: 'Verified', timestamp: new Date().toISOString(), type: 'Buffalo', workerId: 'initial' }
                        ];
                         initialRegs.forEach(reg => {
                            const newKey = push(ref(db, regsRefPath)).key;
                            updates[`${regsRefPath}/${newKey}`] = reg;
                        });
                    }
                    if (Object.keys(updates).length > 0) {
                       await update(ref(db), updates);
                    }
                } catch(err) {
                    console.error("Seeding error: ", err);
                } finally {
                    seeding[type] = false;
                }
            }

            // Observer to initialize logic only when a view becomes visible
            const viewObserver = new MutationObserver((mutations) => {
                for (let mutation of mutations) {
                    if (mutation.attributeName === 'class' && !mutation.target.classList.contains('hidden')) {
                        const viewId = mutation.target.id;
                        if (viewId === 'dashboard-view') initDashboard();
                        if (viewId === 'geospatial-view') initGeospatialView();
                        if (viewId === 'reports-view') initReportsView();
                        if (viewId === 'workers-view') initWorkersView();
                    }
                }
            });

            views.forEach(view => viewObserver.observe(view, { attributes: true }));

            // Initial trigger
            const currentHash = window.location.hash || '#dashboard';
            switchView(currentHash);
            if(currentHash === '#dashboard') initDashboard();
            if(currentHash === '#geospatial') initGeospatialView();
            if(currentHash === '#reports') initReportsView();
            if(currentHash === '#workers') initWorkersView();
        });
    </script>

</body>
</html>
```


    


