<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pashu Pehchan - Authorities Dashboard</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Inter font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Leaflet.js CSS for Interactive Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* A light grey background */
        }
        .sidebar {
            transition: transform 0.3s ease-in-out;
        }
        .main-content {
            transition: margin-left 0.3s ease-in-out;
        }
        .sidebar-closed {
            transform: translateX(-100%);
        }
        .main-content-expanded {
            margin-left: 0;
        }
        @media (min-width: 1024px) {
            .main-content-expanded {
                margin-left: 16rem; /* Default sidebar width */
            }
        }
        /* Leaflet map container style */
        #map, #geospatialMap {
            height: 100%;
            width: 100%;
            border-radius: 0.5rem; /* rounded-lg */
            z-index: 10;
        }
        /* Style for active nav link */
        .nav-link.active {
            background-color: #4a5568; /* bg-gray-700 */
        }
        .nav-link.active .fa-solid,
        .nav-link.active i {
             color: #2dd4bf; /* text-cyan-400 */
        }
        /* Custom searchable dropdown */
        .searchable-dropdown-list {
            max-height: 200px;
            overflow-y: auto;
        }
        /* Toggle switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #06b6d4;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #06b6d4;
        }
         /* Full screen loader */
        #app-loader {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(4px);
        }
        /* Dropdown transition */
        .dropdown {
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Full App Loader -->
    <div id="app-loader" class="fixed inset-0 z-50 flex flex-col items-center justify-center">
        <i class="fas fa-paw text-5xl text-cyan-600 animate-bounce"></i>
        <p class="mt-4 text-lg font-semibold text-gray-700">Initializing Pashu Pehchan...</p>
    </div>

    <!-- Login View -->
    <div id="login-view" class="hidden min-h-screen flex items-center justify-center bg-gray-100">
        <div class="w-full max-w-md p-8 space-y-8 bg-white rounded-2xl shadow-lg">
            <div class="text-center">
                <i class="fas fa-paw text-5xl text-cyan-600"></i>
                <h2 class="mt-4 text-3xl font-bold text-gray-900">
                    Pashu Pehchan Portal
                </h2>
                <p class="mt-2 text-sm text-gray-600">
                    Official Login
                </p>
            </div>
            <form id="login-form" class="mt-8 space-y-6">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <label for="email-address" class="sr-only">Email address</label>
                        <input id="email-address" name="email" type="email" autocomplete="email" required class="appearance-none rounded-none relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-cyan-500 focus:border-cyan-500 focus:z-10 sm:text-sm" placeholder="Email address">
                    </div>
                    <div>
                        <label for="password" class="sr-only">Password</label>
                        <input id="password" name="password" type="password" autocomplete="current-password" required class="appearance-none rounded-none relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-cyan-500 focus:border-cyan-500 focus:z-10 sm:text-sm" placeholder="Password">
                    </div>
                </div>
                <p id="login-error" class="text-sm text-red-600 text-center"></p>
                <div>
                    <button type="submit" class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-cyan-600 hover:bg-cyan-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500">
                        Sign in
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="app-container" class="hidden">
        <!-- Sidebar Navigation -->
        <aside id="sidebar" class="bg-gray-800 text-white w-64 fixed inset-y-0 left-0 z-40 transform lg:transform-none transition-transform duration-300 ease-in-out">
            <div class="p-5 border-b border-gray-700 flex items-center">
                <i class="fas fa-paw text-2xl mr-3 text-cyan-400"></i>
                <h1 class="text-xl font-bold">Pashu Pehchan</h1>
            </div>
            <nav class="mt-5" id="navigation-menu">
                <a href="#dashboard" class="nav-link flex items-center px-6 py-3 text-gray-300 hover:bg-gray-700 active">
                    <i class="fas fa-tachometer-alt w-6"></i>
                    <span class="ml-4">Dashboard</span>
                </a>
                <a href="#geospatial" class="nav-link flex items-center px-6 py-3 text-gray-300 hover:bg-gray-700">
                    <i class="fas fa-map-marked-alt w-6"></i>
                    <span class="ml-4">Geospatial Map</span>
                </a>
                <a href="#reports" class="nav-link flex items-center px-6 py-3 text-gray-300 hover:bg-gray-700">
                    <i class="fas fa-chart-bar w-6"></i>
                    <span class="ml-4">Reports</span>
                </a>
                <a href="#workers" class="nav-link flex items-center px-6 py-3 text-gray-300 hover:bg-gray-700">
                    <i class="fas fa-users w-6"></i>
                    <span class="ml-4">Field Workers</span>
                </a>
                <a href="#settings" class="nav-link flex items-center px-6 py-3 text-gray-300 hover:bg-gray-700">
                    <i class="fas fa-cog w-6"></i>
                    <span class="ml-4">Settings</span>
                </a>
            </nav>
            <div class="absolute bottom-0 w-full p-6">
                <a href="#" id="sidebar-logout-btn" class="flex items-center text-gray-400 hover:text-white">
                    <i class="fas fa-sign-out-alt w-6"></i>
                    <span class="ml-4">Logout</span>
                </a>
            </div>
        </aside>

        <!-- Main Content Area -->
        <div id="main-content" class="ml-0 lg:ml-64 p-6 md:p-8 transition-all duration-300 ease-in-out">
            
            <!-- View: Dashboard -->
            <main id="dashboard-view" class="view">
                <!-- Header -->
                <header class="flex justify-between items-center mb-8">
                    <div>
                        <button id="menu-btn" class="lg:hidden text-gray-600">
                            <i class="fas fa-bars text-2xl"></i>
                        </button>
                        <h2 class="text-3xl font-bold text-gray-800 hidden md:block">Welcome, Administrator</h2>
                        <p class="text-gray-500 hidden md:block">Here's the real-time overview of animal registration and breed data.</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <input type="text" placeholder="Search Animal ID..." class="bg-white border border-gray-300 rounded-full py-2 px-4 pl-10 focus:outline-none focus:ring-2 focus:ring-cyan-500 w-32 sm:w-64">
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                        <div class="relative">
                            <button id="notification-btn" class="relative text-gray-600">
                                <i class="fas fa-bell text-xl"></i>
                                <span class="absolute top-0 right-0 h-2 w-2 bg-red-500 rounded-full"></span>
                            </button>
                            <!-- Notification Dropdown -->
                            <div id="notification-dropdown" class="dropdown hidden absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-xl overflow-hidden z-20 opacity-0 transform scale-95">
                                <div class="p-4 font-bold border-b">Notifications</div>
                                <div class="divide-y">
                                    <a href="#" class="flex items-start p-4 hover:bg-gray-50">
                                        <i class="fas fa-exclamation-circle text-yellow-500 mt-1 mr-3"></i>
                                        <div>
                                            <p class="text-sm text-gray-700 font-semibold">Low Confidence Alert</p>
                                            <p class="text-xs text-gray-500">Registration #Cattle-99ABC requires review.</p>
                                        </div>
                                    </a>
                                    <a href="#" class="flex items-start p-4 hover:bg-gray-50">
                                        <i class="fas fa-check-circle text-green-500 mt-1 mr-3"></i>
                                        <div>
                                            <p class="text-sm text-gray-700 font-semibold">Report Ready</p>
                                            <p class="text-xs text-gray-500">Your weekly report for Odisha is ready.</p>
                                        </div>
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="relative">
                            <button id="account-btn">
                                <img src="https://placehold.co/40x40/E2E8F0/4A5568?text=A" alt="Admin" class="w-10 h-10 rounded-full">
                            </button>
                             <!-- Account Dropdown -->
                            <div id="account-dropdown" class="dropdown hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-xl z-20 opacity-0 transform scale-95">
                                <a href="#settings" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Settings</a>
                                <a href="#" id="dropdown-logout-btn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Logout</a>
                            </div>
                        </div>
                    </div>
                </header>

                <!-- Key Metrics Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-2xl shadow-md flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm font-medium">Total Animals Registered</p>
                            <p id="total-animals-count" class="text-3xl font-bold text-gray-800">0</p>
                        </div>
                        <div class="bg-cyan-100 text-cyan-600 p-4 rounded-full">
                            <i class="fas fa-hippo text-2xl"></i>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-md flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm font-medium">Cattle Registered</p>
                            <p id="cattle-count" class="text-3xl font-bold text-gray-800">0</p>
                        </div>
                        <div class="bg-orange-100 text-orange-600 p-4 rounded-full">
                            <i class="fas fa-cow text-2xl"></i>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-md flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm font-medium">Buffaloes Registered</p>
                            <p id="buffalo-count" class="text-3xl font-bold text-gray-800">0</p>
                        </div>
                        <div class="bg-indigo-100 text-indigo-600 p-4 rounded-full">
                             <i class="fas fa-water text-2xl"></i>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-md flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm font-medium">AI Accuracy</p>
                            <p id="ai-accuracy" class="text-3xl font-bold text-gray-800">0%</p>
                            <p class="text-gray-500 text-sm mt-1">vs Manual Entries</p>
                        </div>
                        <div class="bg-emerald-100 text-emerald-600 p-4 rounded-full">
                            <i class="fas fa-robot text-2xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Charts and Map Section -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                    <!-- Breed Distribution Chart -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-md flex flex-col">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Breed Distribution</h3>
                        <div class="relative" style="height: 320px;">
                            <div id="chart-loader" class="absolute inset-0 flex items-center justify-center z-10">
                                <i class="fas fa-spinner fa-spin text-4xl text-cyan-600"></i>
                            </div>
                            <canvas id="breedChart"></canvas>
                        </div>
                    </div>
                    <!-- Geospatial Distribution Map -->
                    <div class="bg-white p-6 rounded-2xl shadow-md flex flex-col">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Geospatial Distribution</h3>
                        <div class="flex-grow h-64 md:h-auto">
                             <div id="map"></div>
                        </div>
                    </div>
                </div>

                <!-- Recent Registrations Table -->
                <div class="bg-white p-6 rounded-2xl shadow-md">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Recent Registrations</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="text-sm font-semibold text-gray-500 border-b">
                                    <th class="p-4">Animal ID</th>
                                    <th class="p-4">Breed (AI Suggestion)</th>
                                    <th class="p-4">Confidence</th>
                                    <th class="p-4">Location</th>
                                    <th class="p-4">Field Worker</th>
                                    <th class="p-4">Timestamp</th>
                                    <th class="p-4">Status</th>
                                </tr>
                            </thead>
                            <tbody id="recent-registrations-body" class="text-gray-700">
                               <!-- Rows will be dynamically inserted here -->
                               <tr><td colspan="7" class="text-center p-8 text-gray-500">Loading registrations...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>

            <!-- View: Geospatial Report -->
            <main id="geospatial-view" class="view hidden">
                 <header class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800">Geospatial Report</h2>
                        <p class="text-gray-500">Filter and analyze breed distribution by region.</p>
                    </div>
                </header>
                
                <!-- Filter Section -->
                <div class="bg-white p-6 rounded-2xl shadow-md mb-8">
                     <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6 items-end">
                        <!-- Custom Searchable Dropdown for State -->
                        <div class="relative searchable-dropdown-container" id="state-dropdown-container">
                            <label for="state-search" class="block text-sm font-medium text-gray-700 mb-1">State</label>
                            <div class="relative">
                                <input type="text" id="state-search" placeholder="Select State" class="w-full p-2 border border-gray-300 rounded-md focus:ring-cyan-500 focus:border-cyan-500" autocomplete="off">
                                <i class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                            </div>
                            <div id="state-list" class="searchable-dropdown-list absolute hidden w-full bg-white border border-gray-300 rounded-md mt-1 z-20">
                                <!-- State options will be populated by JS -->
                            </div>
                        </div>
                        
                        <!-- Custom Searchable Dropdown for District -->
                        <div class="relative searchable-dropdown-container" id="district-dropdown-container">
                            <label for="district-search" class="block text-sm font-medium text-gray-700 mb-1">District</label>
                             <div class="relative">
                                <input type="text" id="district-search" placeholder="Select District" class="w-full p-2 border border-gray-300 rounded-md focus:ring-cyan-500 focus:border-cyan-500" autocomplete="off" disabled>
                                <i class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                            </div>
                            <div id="district-list" class="searchable-dropdown-list absolute hidden w-full bg-white border border-gray-300 rounded-md mt-1 z-20">
                               <!-- District options will be populated by JS -->
                            </div>
                        </div>
                        
                        <div class="md:col-start-3 lg:col-start-4">
                            <button id="filter-btn" class="w-full bg-cyan-600 text-white font-bold py-2 px-4 rounded-md hover:bg-cyan-700 transition-colors">
                                Apply Filter
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Data Summary Section -->
                <div id="geospatial-summary" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-2xl shadow-md">
                        <p class="text-gray-500 text-sm font-medium">Total Registrations in Area</p>
                        <p id="summary-total" class="text-3xl font-bold text-gray-800">---</p>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-md">
                        <p class="text-gray-500 text-sm font-medium">Most Common Breed</p>
                        <p id="summary-breed" class="text-3xl font-bold text-gray-800">---</p>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-md">
                        <p class="text-gray-500 text-sm font-medium">Latest Registration</p>
                        <p id="summary-date" class="text-3xl font-bold text-gray-800">---</p>
                    </div>
                </div>

                <!-- Map Display -->
                <div class="bg-white p-6 rounded-2xl shadow-md">
                    <div class="h-96 md:h-[600px] w-full">
                        <div id="geospatialMap"></div>
                    </div>
                </div>
            </main>
            
            <!-- View: Reports -->
            <main id="reports-view" class="view hidden">
                <header class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800">Generate Custom Reports</h2>
                        <p class="text-gray-500">Select your criteria to generate a downloadable report.</p>
                    </div>
                </header>

                <div class="bg-white p-8 rounded-2xl shadow-md">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 items-end">
                        <!-- Report Type -->
                        <div>
                            <label for="report-type" class="block text-sm font-medium text-gray-700 mb-1">Report Type</label>
                            <select id="report-type" class="w-full p-2 border border-gray-300 rounded-md focus:ring-cyan-500 focus:border-cyan-500">
                                <option>Breed Distribution Census</option>
                                <option>AI Model Accuracy Analysis</option>
                                <option>Field Worker Activity Log</option>
                            </select>
                        </div>

                        <!-- Date Range -->
                        <div>
                            <label for="report-daterange" class="block text-sm font-medium text-gray-700 mb-1">Date Range</label>
                            <select id="report-daterange" class="w-full p-2 border border-gray-300 rounded-md focus:ring-cyan-500 focus:border-cyan-500">
                                <option>Last 30 Days</option>
                                <option>Last 90 Days</option>
                                <option>This Year</option>
                                <option>All Time</option>
                            </select>
                        </div>
                        
                        <!-- Export Format -->
                        <div>
                            <label for="report-format" class="block text-sm font-medium text-gray-700 mb-1">Export Format</label>
                            <select id="report-format" class="w-full p-2 border border-gray-300 rounded-md focus:ring-cyan-500 focus:border-cyan-500">
                                <option>PDF</option>
                                <option>CSV (Excel)</option>
                            </select>
                        </div>

                        <!-- Location Filters -->
                        <div class="relative md:col-span-2 lg:col-span-3 grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="searchable-dropdown-container" id="report-state-container">
                                <label for="report-state-search" class="block text-sm font-medium text-gray-700 mb-1">State (Optional)</label>
                                <div class="relative">
                                    <input type="text" id="report-state-search" placeholder="All States" class="w-full p-2 border border-gray-300 rounded-md focus:ring-cyan-500 focus:border-cyan-500" autocomplete="off">
                                    <i class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                                </div>
                                <div id="report-state-list" class="searchable-dropdown-list absolute hidden w-full bg-white border border-gray-300 rounded-md mt-1 z-20"></div>
                            </div>
                            <div class="searchable-dropdown-container" id="report-district-container">
                                <label for="report-district-search" class="block text-sm font-medium text-gray-700 mb-1">District (Optional)</label>
                                 <div class="relative">
                                    <input type="text" id="report-district-search" placeholder="All Districts" class="w-full p-2 border border-gray-300 rounded-md focus:ring-cyan-500 focus:border-cyan-500" autocomplete="off" disabled>
                                    <i class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                                </div>
                                <div id="report-district-list" class="searchable-dropdown-list absolute hidden w-full bg-white border border-gray-300 rounded-md mt-1 z-20"></div>
                            </div>
                        </div>
                        
                        <!-- Generate Button -->
                        <div class="lg:col-start-3">
                             <button id="generate-report-btn" class="w-full bg-cyan-600 text-white font-bold py-2 px-4 rounded-md hover:bg-cyan-700 transition-colors flex items-center justify-center">
                                <i class="fas fa-cogs mr-2"></i> Generate Report
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Report Status Section -->
                <div id="report-status" class="mt-8 text-center hidden">
                    <div class="bg-white p-8 rounded-2xl shadow-md inline-block">
                        <div id="report-spinner" class="mb-4">
                            <i class="fas fa-spinner fa-spin text-4xl text-cyan-600"></i>
                            <p class="mt-2 text-gray-600 font-medium">Generating your report, please wait...</p>
                        </div>
                        <div id="report-success" class="hidden">
                             <i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i>
                             <h3 id="report-success-title" class="text-xl font-bold text-gray-800">Report Generated!</h3>
                             <p id="report-success-message" class="text-gray-600 mt-2 mb-4"></p>
                             <a href="#" download="report.pdf" id="download-report-link" class="bg-green-500 text-white font-bold py-2 px-6 rounded-md hover:bg-green-600 transition-colors inline-flex items-center">
                                <i class="fas fa-download mr-2"></i> Download
                             </a>
                        </div>
                    </div>
                </div>

            </main>
            
            <!-- View: Field Workers -->
            <main id="workers-view" class="view hidden">
                <header class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800">Field Worker Management</h2>
                        <p class="text-gray-500">Monitor and manage your field personnel.</p>
                    </div>
                    <button id="add-worker-btn" class="bg-cyan-600 text-white font-bold py-2 px-4 rounded-md hover:bg-cyan-700 transition-colors flex items-center">
                        <i class="fas fa-plus mr-2"></i> Add New Worker
                    </button>
                </header>
                
                <div class="bg-white p-6 rounded-2xl shadow-md">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">All Field Workers</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="text-sm font-semibold text-gray-500 border-b">
                                    <th class="p-4">Worker ID</th>
                                    <th class="p-4">Name</th>
                                    <th class="p-4">Assigned Area</th>
                                    <th class="p-4">Registrations</th>
                                    <th class="p-4">Status</th>
                                    <th class="p-4 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="worker-table-body" class="text-gray-700 divide-y">
                                <!-- Worker rows dynamically inserted here -->
                                 <tr><td colspan="6" class="text-center p-8 text-gray-500">Loading worker data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
            <main id="settings-view" class="view hidden">
                 <header class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800">Settings</h2>
                        <p class="text-gray-500">Manage your account and system preferences.</p>
                    </div>
                </header>
                
                <div class="space-y-8">
                    <!-- Account Settings -->
                    <div class="bg-white p-8 rounded-2xl shadow-md">
                        <h3 class="text-xl font-bold text-gray-800 mb-6">Account Settings</h3>
                        <form class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="admin-name" class="block text-sm font-medium text-gray-700 mb-1">Admin Name</label>
                                    <input type="text" id="admin-name" value="Administrator" class="w-full p-2 border border-gray-300 rounded-md focus:ring-cyan-500 focus:border-cyan-500">
                                </div>
                                <div>
                                    <label for="admin-email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                                    <input type="email" id="admin-email" value="admin@pashupehchan.gov.in" class="w-full p-2 border border-gray-300 rounded-md focus:ring-cyan-500 focus:border-cyan-500">
                                </div>
                            </div>
                            <div>
                                <button type="button" class="text-cyan-600 font-semibold hover:underline">Change Password</button>
                            </div>
                            <div class="pt-4 text-right">
                                <button type="submit" class="px-6 py-2 bg-cyan-600 text-white rounded-md hover:bg-cyan-700 transition-colors">Save Changes</button>
                            </div>
                        </form>
                    </div>

                    <!-- System Settings -->
                     <div class="bg-white p-8 rounded-2xl shadow-md">
                        <h3 class="text-xl font-bold text-gray-800 mb-6">System Settings</h3>
                        <div class="space-y-6">
                            <div>
                                <label for="ai-threshold" class="block text-sm font-medium text-gray-700 mb-1">AI Confidence Threshold</label>
                                <p class="text-xs text-gray-500 mb-2">Suggestions below this value will require mandatory manual review.</p>
                                <select id="ai-threshold" class="w-full md:w-1/3 p-2 border border-gray-300 rounded-md focus:ring-cyan-500 focus:border-cyan-500">
                                    <option>80%</option>
                                    <option selected>85%</option>
                                    <option>90%</option>
                                    <option>95%</option>
                                </select>
                            </div>
                             <div class="border-t pt-6">
                                <h4 class="text-md font-semibold text-gray-700">Data Management</h4>
                                <div class="flex items-center space-x-4 mt-4">
                                    <button class="px-4 py-2 bg-gray-600 text-white text-sm rounded-md hover:bg-gray-700">
                                        <i class="fas fa-database mr-2"></i>Backup Database
                                    </button>
                                    <button class="px-4 py-2 bg-red-600 text-white text-sm rounded-md hover:bg-red-700">
                                        <i class="fas fa-archive mr-2"></i>Archive Old Data
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                     <!-- Notification Settings -->
                    <div class="bg-white p-8 rounded-2xl shadow-md">
                        <h3 class="text-xl font-bold text-gray-800 mb-6">Notification Settings</h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-gray-700">Email Notifications</p>
                                    <p class="text-sm text-gray-500">Receive weekly summary reports via email.</p>
                                </div>
                                <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" name="toggle" id="email-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" checked/>
                                    <label for="email-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                </div>
                            </div>
                             <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-gray-700">Push Notifications</p>
                                    <p class="text-sm text-gray-500">Get alerts for critical system events on your devices.</p>
                                </div>
                                <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" name="toggle" id="push-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                    <label for="push-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </main>

        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center flex">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-sm m-4">
            <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-4">Confirm Action</h3>
            <p id="modal-body" class="text-gray-600 mb-6">Are you sure you want to proceed?</p>
            <div class="flex justify-end space-x-4">
                <button id="modal-cancel-btn" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">Cancel</button>
                <button id="modal-confirm-btn" class="px-6 py-2 bg-cyan-600 text-white rounded-md hover:bg-cyan-700 transition-colors">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Edit Worker Modal -->
    <div id="edit-worker-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center flex">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-lg m-4">
            <h3 class="text-xl font-bold text-gray-800 mb-6">Edit Field Worker Details</h3>
            <form id="edit-worker-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="edit-worker-id" class="block text-sm font-medium text-gray-700 mb-1">Worker ID</label>
                        <input type="text" id="edit-worker-id" class="w-full p-2 bg-gray-100 border border-gray-300 rounded-md" readonly>
                    </div>
                    <div>
                        <label for="edit-worker-name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                        <input type="text" id="edit-worker-name" class="w-full p-2 border border-gray-300 rounded-md focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                    <!-- State Dropdown -->
                    <div class="relative searchable-dropdown-container" id="edit-state-container">
                        <label for="edit-state-search" class="block text-sm font-medium text-gray-700 mb-1">Assigned State</label>
                        <div class="relative">
                            <input type="text" id="edit-state-search" placeholder="Select State" class="w-full p-2 border border-gray-300 rounded-md focus:ring-cyan-500 focus:border-cyan-500" autocomplete="off">
                             <i class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                        </div>
                        <div id="edit-state-list" class="searchable-dropdown-list absolute hidden w-full bg-white border border-gray-300 rounded-md mt-1 z-30"></div>
                    </div>
                    <!-- District Dropdown -->
                    <div class="relative searchable-dropdown-container" id="edit-district-container">
                        <label for="edit-district-search" class="block text-sm font-medium text-gray-700 mb-1">Assigned District</label>
                         <div class="relative">
                            <input type="text" id="edit-district-search" placeholder="Select District" class="w-full p-2 border border-gray-300 rounded-md focus:ring-cyan-500 focus:border-cyan-500" autocomplete="off" disabled>
                             <i class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                        </div>
                        <div id="edit-district-list" class="searchable-dropdown-list absolute hidden w-full bg-white border border-gray-300 rounded-md mt-1 z-30"></div>
                    </div>
                </div>
                <div class="mt-8 flex justify-end space-x-4">
                    <button type="button" id="edit-modal-cancel-btn" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">Cancel</button>
                    <button type="submit" class="px-6 py-2 bg-cyan-600 text-white rounded-md hover:bg-cyan-700 transition-colors">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Worker Modal -->
    <div id="add-worker-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center flex">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-lg m-4">
            <h3 class="text-xl font-bold text-gray-800 mb-6">Add New Field Worker</h3>
            <form id="add-worker-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                     <div>
                        <label for="add-worker-name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                        <input type="text" id="add-worker-name" placeholder="Enter full name" class="w-full p-2 border border-gray-300 rounded-md focus:ring-cyan-500 focus:border-cyan-500" required>
                    </div>
                     <div>
                        <!-- Placeholder for alignment -->
                    </div>
                    <!-- State Dropdown -->
                    <div class="relative searchable-dropdown-container" id="add-state-container">
                        <label for="add-state-search" class="block text-sm font-medium text-gray-700 mb-1">Assigned State</label>
                        <div class="relative">
                            <input type="text" id="add-state-search" placeholder="Select State" class="w-full p-2 border border-gray-300 rounded-md focus:ring-cyan-500 focus:border-cyan-500" autocomplete="off" required>
                             <i class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                        </div>
                        <div id="add-state-list" class="searchable-dropdown-list absolute hidden w-full bg-white border border-gray-300 rounded-md mt-1 z-30"></div>
                    </div>
                    <!-- District Dropdown -->
                    <div class="relative searchable-dropdown-container" id="add-district-container">
                        <label for="add-district-search" class="block text-sm font-medium text-gray-700 mb-1">Assigned District</label>
                         <div class="relative">
                            <input type="text" id="add-district-search" placeholder="Select District" class="w-full p-2 border border-gray-300 rounded-md focus:ring-cyan-500 focus:border-cyan-500" autocomplete="off" disabled required>
                             <i class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                        </div>
                        <div id="add-district-list" class="searchable-dropdown-list absolute hidden w-full bg-white border border-gray-300 rounded-md mt-1 z-30"></div>
                    </div>
                </div>
                <div class="mt-8 flex justify-end space-x-4">
                    <button type="button" id="add-modal-cancel-btn" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">Cancel</button>
                    <button type="submit" class="px-6 py-2 bg-cyan-600 text-white rounded-md hover:bg-cyan-700 transition-colors">Add Worker</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Leaflet.js script -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getDatabase, ref, onValue, set, push, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // --- Firebase Initialization ---
        const firebaseConfig = {
            apiKey: "AIzaSyBtX3TT6oDoICuWSUvEzKPaJxHEk2-J-34",
            authDomain: "sih-win.firebaseapp.com",
            databaseURL: "https://sih-win-default-rtdb.firebaseio.com",
            projectId: "sih-win",
            storageBucket: "sih-win.firebasestorage.app",
            messagingSenderId: "225158149948",
            appId: "1:225158149948:web:cca547ed2f1d142f76d039",
            measurementId: "G-E0B3V5LKF0"
        };
        
        const appId = 'pashu-pehchan-dashboard'; // A unique identifier for this app's data

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // --- Global State ---
        let registrationsUnsubscribe = null;
        let workersUnsubscribe = null;
        let registrationsData = [];
        let workersData = new Map();

        const locationData = {
            "Andaman and Nicobar Islands": { coords: [11.7401, 92.6586], zoom: 9, districts: ["Nicobar", "North and Middle Andaman", "South Andaman"] },
            "Andhra Pradesh": { coords: [15.9129, 79.7400], zoom: 7, districts: ["Anantapur", "Chittoor", "East Godavari", "Guntur", "Krishna", "Kurnool", "Prakasam", "Srikulam", "Visakhapatnam", "West Godavari", "Y.S.R. Kadapa"] },
            "Arunachal Pradesh": { coords: [28.2180, 94.7278], zoom: 7, districts: ["Tawang", "West Kameng", "East Kameng", "Papum Pare", "Kurung Kumey", "Kra Daadi", "Lower Subansiri", "Upper Subansiri", "West Siang", "East Siang", "Siang", "Upper Siang", "Lower Siang", "Lower Dibang Valley", "Dibang Valley", "Anjaw", "Lohit", "Namsai", "Changlang", "Tirap", "Longding"] },
            "Assam": { coords: [26.2006, 92.9376], zoom: 7, districts: ["Baksa", "Barpeta", "Biswanath", "Bongaigaon", "Cachar", "Charaideo", "Chirang", "Darrang", "Dhemaji", "Dhubri", "Dibrugarh", "Dima Hasao", "Goalpara", "Golaghat", "Hailakandi", "Hojai", "Jorhat", "Kamrup", "Kamrup Metropolitan", "Karbi Anglong", "Karimganj", "Kokrajhar", "Lakhimpur", "Majuli", "Morigaon", "Nagaon", "Nalbari", "Sivasagar", "Sonitpur", "South Salmara-Mankachar", "Tinsukia", "Udalguri", "West Karbi Anglong"] },
            "Bihar": { coords: [25.0961, 85.3131], zoom: 7, districts: ["Araria", "Arwal", "Aurangabad", "Banka", "Begusarai", "Bhagalpur", "Bhojpur", "Buxar", "Darbhanga", "East Champaran", "Gaya", "Gopalganj", "Jamui", "Jehanabad", "Kaimur", "Katihar", "Khagaria", "Kishanganj", "Lakhisarai", "Madhepura", "Madhubani", "Munger", "Muzaffarpur", "Nalanda", "Nawada", "Patna", "Purnia", "Rohtas", "Saharsa", "Samastipur", "Saran", "Sheikhpura", "Sheohar", "Sitamarhi", "Siwan", "Supaul", "Vaishali", "West Champaran"] },
            "Chandigarh": { coords: [30.7333, 76.7794], zoom: 12, districts: ["Chandigarh"] },
            "Chhattisgarh": { coords: [21.2787, 81.8661], zoom: 7, districts: ["Balod", "Baloda Bazar", "Balrampur", "Bastar", "Bemetara", "Bijapur", "Bilaspur", "Dantewada", "Dhamtari", "Durg", "Gariaband", "Janjgir-Champa", "Jashpur", "Kabirdham", "Kanker", "Kondagaon", "Korba", "Koriya", "Mahasamund", "Mungeli", "Narayanpur", "Raigarh", "Raipur", "Rajnandgaon", "Sukma", "Surajpur", "Surguja"] },
            "Dadra and Nagar Haveli and Daman and Diu": { coords: [20.1809, 73.0169], zoom: 9, districts: ["Dadra and Nagar Haveli", "Daman", "Diu"] },
            "Delhi": { coords: [28.7041, 77.1025], zoom: 10, districts: ["Central Delhi", "East Delhi", "New Delhi", "North Delhi", "North East Delhi", "North West Delhi", "Shahdara", "South Delhi", "South East Delhi", "South West Delhi", "West Delhi"] },
            "Goa": { coords: [15.2993, 74.1240], zoom: 9, districts: ["North Goa", "South Goa"] },
            "Gujarat": { coords: [22.2587, 71.1924], zoom: 7, districts: ["Ahmedabad", "Amreli", "Anand", "Aravalli", "Banaskantha", "Bharuch", "Bhavnagar", "Botad", "Chhota Udaipur", "Dahod", "Dang", "Devbhoomi Dwarka", "Gandhinagar", "Gir Somnath", "Jamnagar", "Junagadh", "Kheda", "Kutch", "Mahisagar", "Mehsana", "Morbi", "Narmada", "Navsari", "Panchmahal", "Patan", "Porbandar", "Rajkot", "Sabarkantha", "Surat", "Surendranagar", "Tapi", "Vadodara", "Valsad"] },
            "Haryana": { coords: [29.0588, 76.0856], zoom: 8, districts: ["Ambala", "Bhiwani", "Charkhi Dadri", "Faridabad", "Fatehabad", "Gurugram", "Hisar", "Jhajjar", "Jind", "Kaithal", "Karnal", "Kurukshetra", "Mahendragarh", "Nuh", "Palwal", "Panchkula", "Panipat", "Rewari", "Rohtak", "Sirsa", "Sonipat", "Yamunanagar"] },
            "Himachal Pradesh": { coords: [31.1048, 77.1734], zoom: 8, districts: ["Bilaspur", "Chamba", "Hamirpur", "Kangra", "Kinnaur", "Kullu", "Lahaul and Spiti", "Mandi", "Shimla", "Sirmaur", "Solan", "Una"] },
            "Jammu and Kashmir": { coords: [33.7782, 76.5762], zoom: 7, districts: ["Anantnag", "Bandipora", "Baramulla", "Budgam", "Doda", "Ganderbal", "Jammu", "Kathua", "Kishtwar", "Kulgam", "Kupwara", "Poonch", "Pulwama", "Rajouri", "Ramban", "Reasi", "Samba", "Shopian", "Srinagar", "Udhampur"] },
            "Jharkhand": { coords: [23.6102, 85.2799], zoom: 7, districts: ["Bokaro", "Chatra", "Deoghar", "Dhanbad", "Dumka", "East Singhbhum", "Garhwa", "Giridih", "Godda", "Gumla", "Hazaribagh", "Jamtara", "Khunti", "Koderma", "Latehar", "Lohardaga", "Pakur", "Palamu", "Ramgarh", "Ranchi", "Sahebganj", "Seraikela Kharsawan", "Simdega", "West Singhbhum"] },
            "Karnataka": { coords: [15.3173, 75.7139], zoom: 7, districts: ["Bagalkot", "Ballari", "Belagavi", "Bengaluru Rural", "Bengaluru Urban", "Bidar", "Chamarajanagar", "Chikkaballapur", "Chikkamagaluru", "Chitradurga", "Dakshina Kannada", "Davanagere", "Dharwad", "Gadag", "Hassan", "Haveri", "Kalaburagi", "Kodagu", "Kolar", "Koppal", "Mandya", "Mysuru", "Raichur", "Ramanagara", "Shivamogga", "Tumakuru", "Udupi", "Uttara Kannada", "Vijayapura", "Yadgir"] },
            "Kerala": { coords: [10.8505, 76.2711], zoom: 8, districts: ["Alappuzha", "Ernakulam", "Idukki", "Kannur", "Kasaragod", "Kollam", "Kottayam", "Kozhikode", "Malappuram", "Palakkad", "Pathanamthitta", "Thiruvananthapuram", "Thrissur", "Wayanad"] },
            "Ladakh": { coords: [34.1526, 77.5771], zoom: 7, districts: ["Kargil", "Leh"] },
            "Lakshadweep": { coords: [10.5667, 72.6417], zoom: 9, districts: ["Lakshadweep"] },
            "Madhya Pradesh": { coords: [22.9734, 78.6569], zoom: 6, districts: ["Agar Malwa", "Alirajpur", "Anuppur", "Ashoknagar", "Balaghat", "Barwani", "Betul", "Bhind", "Bhopal", "Burhanpur", "Chhatarpur", "Chhindwara", "Damoh", "Datia", "Dewas", "Dhar", "Dindori", "Guna", "Gwalior", "Harda", "Hoshangabad", "Indore", "Jabalpur", "Jhabua", "Katni", "Khandwa", "Khargone", "Mandla", "Mandsaur", "Morena", "Narsinghpur", "Neemuch", "Panna", "Raisen", "Rajgarh", "Ratlam", "Rewa", "Sagar", "Satna", "Sehore", "Seoni", "Shahdol", "Shajapur", "Sheopur", "Shivpuri", "Sidhi", "Singrauli", "Tikamgarh", "Ujjain", "Umaria", "Vidisha"] },
            "Maharashtra": { coords: [19.7515, 75.7139], zoom: 6, districts: ["Ahmednagar", "Akola", "Amravati", "Aurangabad", "Beed", "Bhandara", "Buldhana", "Chandrapur", "Dhule", "Gadchiroli", "Gondia", "Hingoli", "Jalgaon", "Jalna", "Kolhapur", "Latur", "Mumbai City", "Mumbai Suburban", "Nagpur", "Nanded", "Nandurbar", "Nashik", "Osmanabad", "Palghar", "Parbhani", "Pune", "Raigad", "Ratnagiri", "Sangli", "Satara", "Sindhudurg", "Solapur", "Thane", "Wardha", "Washim", "Yavatmal"] },
            "Manipur": { coords: [24.6637, 93.9063], zoom: 8, districts: ["Bishnupur", "Chandel", "Churachandpur", "Imphal East", "Imphal West", "Jiribam", "Kakching", "Kamjong", "Kangpokpi", "Noney", "Pherzawl", "Senapati", "Tamenglong", "Tengnoupal", "Thoubal", "Ukhrul"] },
            "Meghalaya": { coords: [25.4670, 91.3662], zoom: 8, districts: ["East Garo Hills", "East Jaintia Hills", "East Khasi Hills", "North Garo Hills", "Ri Bhoi", "South Garo Hills", "South West Garo Hills", "South West Khasi Hills", "West Garo Hills", "West Jaintia Hills", "West Khasi Hills"] },
            "Mizoram": { coords: [23.1645, 92.9376], zoom: 8, districts: ["Aizawl", "Champhai", "Kolasib", "Lawngtlai", "Lunglei", "Mamit", "Saiha", "Serchhip"] },
            "Nagaland": { coords: [26.1584, 94.5624], zoom: 8, districts: ["Dimapur", "Kiphire", "Kohima", "Longleng", "Mokokchung", "Mon", "Peren", "Phek", "Tuensang", "Wokha", "Zunheboto"] },
            "Odisha": { coords: [20.9517, 85.0985], zoom: 7, districts: ["Angul", "Balangir", "Balasore", "Bargarh", "Bhadrak", "Boudh", "Cuttack", "Deogarh", "Dhenkanal", "Gajapati", "Ganjam", "Jagatsinghpur", "Jajpur", "Jharsuguda", "Kalahandi", "Kandhamal", "Kendrapara", "Kendujhar", "Khordha", "Koraput", "Malkangiri", "Mayurbhanj", "Nabarangpur", "Nayagarh", "Nuapada", "Puri", "Rayagada", "Sambalpur", "Sonepur", "Sundargarh"] },
            "Puducherry": { coords: [11.9416, 79.8083], zoom: 10, districts: ["Karaikal", "Mahe", "Puducherry", "Yanam"] },
            "Punjab": { coords: [31.1471, 75.3412], zoom: 8, districts: ["Amritsar", "Barnala", "Bathinda", "Faridkot", "Fatehgarh Sahib", "Fazilka", "Ferozepur", "Gurdaspur", "Hoshiarpur", "Jalandhar", "Kapurthala", "Ludhiana", "Mansa", "Moga", "Muktsar", "Pathankot", "Patiala", "Rupnagar", "Sahibzada Ajit Singh Nagar", "Sangrur", "Shahid Bhagat Singh Nagar", "Tarn Taran"] },
            "Rajasthan": { coords: [27.0238, 74.2179], zoom: 6, districts: ["Ajmer", "Alwar", "Banswara", "Baran", "Barmer", "Bharatpur", "Bhilwara", "Bikaner", "Bundi", "Chittorgarh", "Churu", "Dausa", "Dholpur", "Dungarpur", "Hanumangarh", "Jaipur", "Jaisalmer", "Jalore", "Jhalawar", "Jhunjhunu", "Jodhpur", "Karauli", "Kota", "Nagaur", "Pali", "Pratapgarh", "Rajsamand", "Sawai Madhopur", "Sikar", "Sirohi", "Sri Ganganagar", "Tonk", "Udaipur"] },
            "Sikkim": { coords: [27.5330, 88.5122], zoom: 9, districts: ["East Sikkim", "North Sikkim", "South Sikkim", "West Sikkim"] },
            "Tamil Nadu": { coords: [11.1271, 78.6569], zoom: 7, districts: ["Ariyalur", "Chengalpattu", "Chennai", "Coimbatore", "Cuddalore", "Dharmapuri", "Dindigul", "Erode", "Kallakurichi", "Kanchipuram", "Kanyakumari", "Karur", "Krishnagiri", "Madurai", "Nagapattinam", "Namakkal", "Nilgiris", "Perambalur", "Pudukkottai", "Ramanathapuram", "Ranipet", "Salem", "Sivaganga", "Tenkasi", "Thanjavur", "Theni", "Thoothukudi", "Tiruchirappalli", "Tirunelveli", "Tirupathur", "Tiruppur", "Tiruvallur", "Tiruvannamalai", "Tiruvarur", "Vellore", "Viluppuram", "Virudhunagar"] },
            "Telangana": { coords: [18.1124, 79.0193], zoom: 8, districts: ["Adilabad", "Bhadradri Kothagudem", "Hyderabad", "Jagtial", "Jangaon", "Jayashankar Bhupalpally", "Jogulamba Gadwal", "Kamareddy", "Karimnagar", "Khammam", "Komaram Bheem", "Mahabubabad", "Mahabubnagar", "Mancherial", "Medak", "Medchal-Malkajgiri", "Nagarkurnool", "Nalgonda", "Nirmal", "Nizamabad", "Peddapalli", "Rajanna Sircilla", "Rangareddy", "Sangareddy", "Siddipet", "Suryapet", "Vikarabad", "Wanaparthy", "Warangal Rural", "Warangal Urban", "Yadadri Bhuvanagiri"] },
            "Tripura": { coords: [23.9408, 91.9882], zoom: 9, districts: ["Dhalai", "Gomati", "Khowai", "North Tripura", "Sepahijala", "South Tripura", "Unakoti", "West Tripura"] },
            "Uttar Pradesh": { coords: [26.8467, 80.9462], zoom: 6, districts: ["Agra", "Aligarh", "Ambedkar Nagar", "Amethi", "Amroha", "Auraiya", "Ayodhya", "Azamgarh", "Baghpat", "Bahraich", "Ballia", "Balrampur", "Banda", "Barabanki", "Bareilly", "Basti", "Bhadohi", "Bijnor", "Budaun", "Bulandshahr", "Chandauli", "Chitrakoot", "Deoria", "Etah", "Etawah", "Farrukhabad", "Fatehpur", "Firozabad", "Gautam Buddh Nagar", "Ghaziabad", "Ghazipur", "Gonda", "Gorakhpur", "Hamirpur", "Hapur", "Hardoi", "Hathras", "Jalaun", "Jaunpur", "Jhansi", "Kannauj", "Kanpur Dehat", "Kanpur Nagar", "Kasganj", "Kaushambi", "Kheri", "Kushinagar", "Lalitpur", "Lucknow", "Maharajganj", "Mahoba", "Mainpuri", "Mathura", "Mau", "Meerut", "Mirzapur", "Moradabad", "Muzaffarnagar", "Pilibhit", "Pratapgarh", "Prayagraj", "Raebareli", "Rampur", "Saharanpur", "Sambhal", "Sant Kabir Nagar", "Shahjahanpur", "Shamli", "Shravasti", "Siddharthnagar", "Sitapur", "Sonbhadra", "Sultanpur", "Unnao", "Varanasi"] },
            "Uttarakhand": { coords: [30.0668, 79.0193], zoom: 8, districts: ["Almora", "Bageshwar", "Chamoli", "Champawat", "Dehradun", "Haridwar", "Nainital", "Pauri Garhwal", "Pithoragarh", "Rudraprayag", "Tehri Garhwal", "Udham Singh Nagar", "Uttarkashi"] },
            "West Bengal": { coords: [22.9868, 87.8550], zoom: 7, districts: ["Alipurduar", "Bankura", "Birbhum", "Cooch Behar", "Dakshin Dinajpur", "Darjeeling", "Hooghly", "Howrah", "Jalpaiguri", "Jhargram", "Kalimpong", "Kolkata", "Malda", "Murshidabad", "Nadia", "North 24 Parganas", "Paschim Bardhaman", "Paschim Medinipur", "Purba Bardhaman", "Purba Medinipur", "Purulia", "South 24 Parganas", "Uttar Dinajpur"] }
        };

        document.addEventListener('DOMContentLoaded', function () {
            // --- Common Elements ---
            const appLoader = document.getElementById('app-loader');
            const loginView = document.getElementById('login-view');
            const appContainer = document.getElementById('app-container');
            const loginForm = document.getElementById('login-form');
            const loginError = document.getElementById('login-error');
            const sidebarLogoutBtn = document.getElementById('sidebar-logout-btn');
            const dropdownLogoutBtn = document.getElementById('dropdown-logout-btn');

            const menuBtn = document.getElementById('menu-btn');
            const sidebar = document.getElementById('sidebar');

            const notificationBtn = document.getElementById('notification-btn');
            const notificationDropdown = document.getElementById('notification-dropdown');
            const accountBtn = document.getElementById('account-btn');
            const accountDropdown = document.getElementById('account-dropdown');
            
            // --- SPA Navigation Logic ---
            const navLinks = document.querySelectorAll('.nav-link');
            const views = document.querySelectorAll('.view');
            
            function switchView(hash) {
                views.forEach(view => view.classList.add('hidden'));
                navLinks.forEach(link => link.classList.remove('active'));
                const activeView = document.getElementById(hash.substring(1) + '-view');
                const activeLink = document.querySelector(`.nav-link[href="${hash}"]`);
                if (activeView) activeView.classList.remove('hidden');
                if (activeLink) activeLink.classList.add('active');
            }
            
            navLinks.forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    window.location.hash = this.getAttribute('href');
                });
            });
            
            window.addEventListener('hashchange', () => switchView(window.location.hash || '#dashboard'));
            switchView(window.location.hash || '#dashboard');


            // --- Sidebar Toggle ---
            menuBtn.addEventListener('click', () => {
                sidebar.classList.toggle('sidebar-closed');
            });
            
            // --- Header Dropdown Logic ---
            notificationBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleDropdown(notificationDropdown);
                accountDropdown.classList.add('hidden', 'opacity-0', 'scale-95');
            });

            accountBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleDropdown(accountDropdown);
                notificationDropdown.classList.add('hidden', 'opacity-0', 'scale-95');
            });
            
            function toggleDropdown(dropdown) {
                if (dropdown.classList.contains('hidden')) {
                    dropdown.classList.remove('hidden');
                    setTimeout(() => dropdown.classList.remove('opacity-0', 'scale-95'), 10);
                } else {
                    dropdown.classList.add('opacity-0', 'scale-95');
                    setTimeout(() => dropdown.classList.add('hidden'), 200);
                }
            }
            
            window.addEventListener('click', () => {
                if (!notificationDropdown.classList.contains('hidden')) {
                     notificationDropdown.classList.add('opacity-0', 'scale-95');
                    setTimeout(() => notificationDropdown.classList.add('hidden'), 200);
                }
                if (!accountDropdown.classList.contains('hidden')) {
                    accountDropdown.classList.add('opacity-0', 'scale-95');
                    setTimeout(() => accountDropdown.classList.add('hidden'), 200);
                }
            });


            // --- Dashboard Specific Logic ---
            const chartLoader = document.getElementById('chart-loader');
            const breedChartCanvas = document.getElementById('breedChart');
            let breedChart;
            let map;
            
            function initDashboard() {
                setTimeout(() => {
                    if (!map) {
                        map = L.map('map').setView([22.5937, 78.9629], 5);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                    }
                }, 100);

                if (breedChart) return;
                const ctx = breedChartCanvas.getContext('2d');
                breedChart = new Chart(ctx, { type: 'bar', data: { labels: [], datasets: [{ label: 'Number of Animals', data: [], backgroundColor: [], borderColor: [], borderWidth: 1, borderRadius: 5 }] }, options: { animation: { duration: 500 }, responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: '#e5e7eb' } }, x: { grid: { display: false } } } } });
            }
            
            function updateDashboardUI(data) {
                // Metrics
                const total = data.length;
                const cattle = data.filter(r => r.type === 'Cattle').length;
                const buffalo = data.filter(r => r.type === 'Buffalo').length;
                const verified = data.filter(r => r.status === 'Verified').length;

                document.getElementById('total-animals-count').textContent = total.toLocaleString('en-IN');
                document.getElementById('cattle-count').textContent = cattle.toLocaleString('en-IN');
                document.getElementById('buffalo-count').textContent = buffalo.toLocaleString('en-IN');
                document.getElementById('ai-accuracy').textContent = total > 0 ? `${((verified / total) * 100).toFixed(1)}%` : '0%';

                // Breed Chart
                const breedCounts = data.reduce((acc, reg) => {
                    acc[reg.breed] = (acc[reg.breed] || 0) + 1;
                    return acc;
                }, {});
                const sortedBreeds = Object.entries(breedCounts).sort(([,a],[,b]) => b-a).slice(0, 10);
                const chartLabels = sortedBreeds.map(([breed]) => breed);
                const chartData = sortedBreeds.map(([,count]) => count);
                const colors = ['rgba(22, 163, 163, 0.7)', 'rgba(234, 88, 12, 0.7)', 'rgba(220, 38, 38, 0.7)', 'rgba(79, 70, 229, 0.7)', 'rgba(147, 51, 234, 0.7)', 'rgba(217, 119, 6, 0.7)', 'rgba(5, 150, 105, 0.7)', 'rgba(59, 130, 246, 0.7)', 'rgba(139, 92, 246, 0.7)', 'rgba(236, 72, 153, 0.7)'];
                
                if (breedChart) {
                    chartLoader.style.display = 'none';
                    breedChart.data.labels = chartLabels;
                    breedChart.data.datasets[0].data = chartData;
                    breedChart.data.datasets[0].backgroundColor = colors.slice(0, chartLabels.length);
                    breedChart.update();
                }

                // Recent Registrations Table
                const tableBody = document.getElementById('recent-registrations-body');
                tableBody.innerHTML = '';
                const recent = data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0, 5);
                if (recent.length === 0) {
                     tableBody.innerHTML = '<tr><td colspan="7" class="text-center p-8 text-gray-500">No registrations found.</td></tr>';
                } else {
                    recent.forEach(reg => {
                        const statusClass = reg.status === 'Verified' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700';
                        const confidenceClass = reg.confidence > 95 ? 'text-green-600' : 'text-orange-600';
                        const workerName = workersData.get(reg.workerId)?.name || 'Unknown';
                        const row = `
                            <tr>
                                <td class="p-4 font-medium">${reg.animalId || 'N/A'}</td>
                                <td class="p-4">${reg.breed}</td>
                                <td class="p-4 ${confidenceClass}">${parseFloat(reg.confidence).toFixed(1)}%</td>
                                <td class="p-4">${reg.location || 'N/A'}</td>
                                <td class="p-4">${workerName}</td>
                                <td class="p-4">${new Date(reg.timestamp).toLocaleString()}</td>
                                <td class="p-4"><span class="${statusClass} py-1 px-3 rounded-full text-xs font-semibold">${reg.status || 'Pending'}</span></td>
                            </tr>
                        `;
                        tableBody.innerHTML += row;
                    });
                }
            }

            // --- Geospatial View Specific Logic ---
            let geospatialMap;
            
            function initGeospatialView() {
                setTimeout(() => {
                    if (!geospatialMap) {
                         geospatialMap = L.map('geospatialMap').setView([22.5937, 78.9629], 5);
                         L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(geospatialMap);
                    }
                }, 100);
            }

            let mapMarkers = [];
            function applyMapFilter() {
                const state = document.getElementById('state-search').value;
                const district = document.getElementById('district-search').value;
                mapMarkers.forEach(marker => geospatialMap.removeLayer(marker));
                mapMarkers = [];
                // Filtering logic will now use the global `registrationsData`
                const filteredData = registrationsData.filter(reg => {
                    if (district && state) return reg.location.includes(district) && reg.location.includes(state);
                    if (state) return reg.location.includes(state);
                    return true;
                });
                
                const markerCoords = [];
                const locationCounts = filteredData.reduce((acc, reg) => {
                    const key = `${reg.location}-${reg.breed}`;
                    if(!acc[key]) acc[key] = { count: 0, lat: reg.lat, lng: reg.lng, breed: reg.breed };
                    acc[key].count++;
                    return acc;
                }, {});

                Object.values(locationCounts).forEach(d => {
                     const marker = L.marker([d.lat, d.lng]).addTo(geospatialMap).bindPopup(`<b>${d.breed}</b><br>${d.count.toLocaleString('en-IN')} registered.`);
                    mapMarkers.push(marker);
                    markerCoords.push([d.lat, d.lng]);
                });

                if (markerCoords.length > 1) geospatialMap.fitBounds(L.latLngBounds(markerCoords).pad(0.2));
                else if (markerCoords.length === 1) geospatialMap.setView(markerCoords[0], 13);
                // Summary section update... (Can be enhanced)
            }
            
            // --- Reports View Specific Logic ---
            function initReportsView() {
                document.getElementById('generate-report-btn').addEventListener('click', generateReport);
            }

            function generateReport() {
                const reportStatus = document.getElementById('report-status');
                reportStatus.classList.remove('hidden');
                document.getElementById('report-spinner').classList.remove('hidden');
                document.getElementById('report-success').classList.add('hidden');
                setTimeout(() => {
                    document.getElementById('report-spinner').classList.add('hidden');
                    document.getElementById('report-success').classList.remove('hidden');
                }, 2000);
            }

            // --- Field Workers View Specific Logic ---
            const confirmationModal = document.getElementById('confirmation-modal');
            const editWorkerModal = document.getElementById('edit-worker-modal');
            const editWorkerForm = document.getElementById('edit-worker-form');
            const addWorkerModal = document.getElementById('add-worker-modal');
            const addWorkerForm = document.getElementById('add-worker-form');
            const addWorkerBtn = document.getElementById('add-worker-btn');
            let currentEditingWorkerId = null;

            function initWorkersView() {
                addWorkerBtn.addEventListener('click', openAddModal);
                document.getElementById('modal-cancel-btn').addEventListener('click', () => confirmationModal.classList.add('hidden'));
                document.getElementById('edit-modal-cancel-btn').addEventListener('click', () => editWorkerModal.classList.add('hidden'));
                document.getElementById('add-modal-cancel-btn').addEventListener('click', () => addWorkerModal.classList.add('hidden'));
                addWorkerForm.addEventListener('submit', saveNewWorker);
                editWorkerForm.addEventListener('submit', saveWorkerChanges);
            }

            function updateWorkersUI(workersMap) {
                const tableBody = document.getElementById('worker-table-body');
                tableBody.innerHTML = '';
                if (workersMap.size === 0) {
                     tableBody.innerHTML = '<tr><td colspan="6" class="text-center p-8 text-gray-500">No field workers found.</td></tr>';
                     return;
                }
                workersMap.forEach((worker, id) => {
                    const row = tableBody.insertRow();
                    row.dataset.id = id;
                    const statusActive = worker.status === 'Active';
                    row.innerHTML = `
                        <td class="p-4 font-medium">${worker.workerId}</td>
                        <td class="p-4">${worker.name}</td>
                        <td class="p-4">${worker.assignedArea}</td>
                        <td class="p-4">${worker.registrations.toLocaleString('en-IN')}</td>
                        <td class="p-4 status-cell"><span class="py-1 px-3 rounded-full text-xs font-semibold ${statusActive ? 'bg-green-100 text-green-700' : 'bg-gray-200 text-gray-700'}">${worker.status}</span></td>
                        <td class="p-4 text-center space-x-2 action-cell">
                            <button class="text-blue-500 hover:text-blue-700" title="Edit Worker"><i class="fas fa-edit"></i></button>
                            <button class="${statusActive ? 'text-red-500 hover:text-red-700' : 'text-green-500 hover:text-green-700'}" title="${statusActive ? 'Deactivate' : 'Activate'} Worker"><i class="fas ${statusActive ? 'fa-user-slash' : 'fa-user-check'}"></i></button>
                        </td>
                    `;
                });
                tableBody.querySelectorAll('.action-cell button').forEach(btn => btn.addEventListener('click', handleWorkerAction));
            }
            
            async function openAddModal() {
                addWorkerForm.reset();
                document.getElementById('add-district-search').disabled = true;
                addWorkerModal.classList.remove('hidden');
            }

            async function saveNewWorker(e) {
                e.preventDefault();
                const name = document.getElementById('add-worker-name').value;
                const state = document.getElementById('add-state-search').value;
                const district = document.getElementById('add-district-search').value;
                const workerId = `FW-${Date.now().toString().slice(-4)}`;
                
                try {
                    const workersRef = ref(db, `artifacts/${appId}/public/data/workers`);
                    const newWorkerRef = push(workersRef);
                    await set(newWorkerRef, {
                        workerId, name, status: 'Active',
                        assignedArea: `${district}, ${state}`,
                        registrations: 0
                    });
                    addWorkerModal.classList.add('hidden');
                } catch (error) {
                    console.error("Error adding worker: ", error);
                    alert('Failed to add worker.');
                }
            }

            function handleWorkerAction(event) {
                const button = event.currentTarget;
                const row = button.closest('tr');
                const workerId = row.dataset.id;
                const worker = workersData.get(workerId);
                let action = '';
                if (button.title.includes('Edit')) action = 'edit';
                else if (button.title.includes('Deactivate')) action = 'deactivate';
                else if (button.title.includes('Activate')) action = 'activate';

                if (action === 'edit') openEditModal(worker, workerId);
                else showConfirmationModal(action, worker.name, workerId);
            }
            
            function openEditModal(worker, id) {
                currentEditingWorkerId = id;
                const area = worker.assignedArea.split(', ');
                document.getElementById('edit-worker-id').value = worker.workerId;
                document.getElementById('edit-worker-name').value = worker.name;
                document.getElementById('edit-state-search').value = area[1];
                document.getElementById('edit-district-search').value = area[0];
                document.getElementById('edit-district-search').disabled = false;
                editWorkerModal.classList.remove('hidden');
            }

            async function saveWorkerChanges(e) {
                e.preventDefault();
                if (!currentEditingWorkerId) return;
                const workerRef = ref(db, `artifacts/${appId}/public/data/workers/${currentEditingWorkerId}`);
                try {
                    await update(workerRef, {
                        name: document.getElementById('edit-worker-name').value,
                        assignedArea: `${document.getElementById('edit-district-search').value}, ${document.getElementById('edit-state-search').value}`
                    });
                    editWorkerModal.classList.add('hidden');
                } catch(error) {
                    console.error("Error updating worker: ", error);
                    alert("Failed to update worker.");
                }
            }

            function showConfirmationModal(action, workerName, workerId) {
                confirmationModal.classList.remove('hidden');
                let message = action === 'deactivate' ? `Deactivate ${workerName}? Access will be revoked.` : `Activate ${workerName}? They will regain access.`;
                document.getElementById('modal-body').textContent = message;

                const confirmBtn = document.getElementById('modal-confirm-btn');
                const actionHandler = () => performStatusAction(action, workerId);
                confirmBtn.addEventListener('click', actionHandler, { once: true });
                document.getElementById('modal-cancel-btn').addEventListener('click', () => confirmBtn.removeEventListener('click', actionHandler), { once: true });
            }

            async function performStatusAction(action, workerId) {
                const newStatus = action === 'activate' ? 'Active' : 'Inactive';
                const workerRef = ref(db, `artifacts/${appId}/public/data/workers/${workerId}`);
                try {
                    await update(workerRef, { status: newStatus });
                    confirmationModal.classList.add('hidden');
                } catch (error) {
                    console.error("Error changing status: ", error);
                    alert('Failed to change worker status.');
                }
            }


            // --- Generic Searchable Dropdown Logic ---
            function initAllDropdowns() {
                const allDropdowns = document.querySelectorAll('.searchable-dropdown-container');
                allDropdowns.forEach(container => {
                    const searchInput = container.querySelector('input');
                    const listContainer = container.querySelector('.searchable-dropdown-list');
                    
                    searchInput.addEventListener('click', (e) => {
                         e.stopPropagation();
                         closeAllDropdowns(listContainer);
                         listContainer.classList.remove('hidden');
                         populateDropdownList(searchInput, listContainer);
                    });
                    
                    searchInput.addEventListener('input', () => populateDropdownList(searchInput, listContainer));
                });
            }
            
            function populateDropdownList(input, list) {
                 const type = input.id.includes('state') ? 'state' : 'district';
                 const searchTerm = input.value.toLowerCase();
                 let items = [];
                 if (type === 'state') {
                     items = Object.keys(locationData);
                 } else {
                     const stateInputId = input.id.replace('district', 'state');
                     const selectedState = document.getElementById(stateInputId).value;
                     if(selectedState && locationData[selectedState]) {
                        items = locationData[selectedState].districts;
                     }
                 }

                list.innerHTML = '';
                items.filter(item => item.toLowerCase().includes(searchTerm)).forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'p-2 hover:bg-gray-100 cursor-pointer';
                    div.textContent = item;
                    div.addEventListener('mousedown', () => selectItem(input, item));
                    list.appendChild(div);
                });
            }

            function selectItem(input, value) {
                input.value = value;
                const type = input.id.includes('state') ? 'state' : 'district';
                if(type === 'state') {
                    const districtInputId = input.id.replace('state', 'district');
                    const districtInput = document.getElementById(districtInputId);
                    districtInput.disabled = false;
                    districtInput.value = '';
                }
            }

            function closeAllDropdowns(exceptThisOne) {
                 document.querySelectorAll('.searchable-dropdown-list').forEach(list => {
                    if (list !== exceptThisOne) {
                        list.classList.add('hidden');
                    }
                });
            }
            
            document.addEventListener('click', () => closeAllDropdowns());

            // --- App Initialization & Firebase Auth ---
            onAuthStateChanged(auth, user => {
                appLoader.classList.add('hidden');
                if (user) {
                    loginView.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    setupRealtimeListeners();
                } else {
                    appContainer.classList.add('hidden');
                    loginView.classList.remove('hidden');
                    if (registrationsUnsubscribe) registrationsUnsubscribe();
                    if (workersUnsubscribe) workersUnsubscribe();
                }
            });

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                loginError.textContent = '';
                const email = document.getElementById('email-address').value;
                const password = document.getElementById('password').value;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    loginError.textContent = 'Error: Invalid email or password.';
                }
            });

            const handleLogout = (e) => {
                e.preventDefault();
                signOut(auth).catch(error => console.error('Sign out error', error));
            };
            sidebarLogoutBtn.addEventListener('click', handleLogout);
            dropdownLogoutBtn.addEventListener('click', handleLogout);

            function setupRealtimeListeners() {
                if (registrationsUnsubscribe) registrationsUnsubscribe();
                if (workersUnsubscribe) workersUnsubscribe();
                
                const registrationsRef = ref(db, 'predictions');
                registrationsUnsubscribe = onValue(registrationsRef, (snapshot) => {
                    const data = snapshot.val() || {};
                    const allPredictions = Object.keys(data).map(key => ({ id: key, ...data[key] }));
                    
                    registrationsData = allPredictions
                        .filter(reg => reg.confidence && parseFloat(reg.confidence) > 50)
                        .map(reg => ({ ...reg, timestamp: new Date(reg.timestamp) }));

                    if (allPredictions.length === 0) seedInitialData('registrations');
                    
                    updateDashboardUI(registrationsData);
                }, (error) => console.error("Error fetching predictions:", error));
                
                const workersRef = ref(db, `artifacts/${appId}/public/data/workers`);
                workersUnsubscribe = onValue(workersRef, (snapshot) => {
                    const data = snapshot.val() || {};
                    workersData.clear();
                    Object.keys(data).forEach(key => workersData.set(key, { id: key, ...data[key] }));
                    if (workersData.size === 0) seedInitialData('workers');
                    updateWorkersUI(workersData);
                });
            }
            
            let seeding = { workers: false, registrations: false };
            async function seedInitialData(type) {
                if (seeding[type]) return;
                seeding[type] = true;
                console.log(`Seeding initial data for ${type}...`);
                const updates = {};
                
                try {
                    if(type === 'workers') {
                        const workersRefPath = `artifacts/${appId}/public/data/workers`;
                        const initialWorkers = [
                            { workerId: 'FW-1023', name: 'Ramesh Kumar', assignedArea: 'Anand, Gujarat', registrations: 1245, status: 'Active' },
                            { workerId: 'FW-1024', name: 'Sunita Devi', assignedArea: 'Rohtak, Haryana', registrations: 987, status: 'Active' }
                        ];
                        initialWorkers.forEach(worker => {
                            const newKey = push(ref(db, workersRefPath)).key;
                            updates[`${workersRefPath}/${newKey}`] = worker;
                        });
                    }
                    if(type === 'registrations') {
                        const regsRefPath = 'predictions';
                        const initialRegs = [
                            { animalId: '#Cattle-78A5B', breed: 'Gir', confidence: 98.2, location: 'Anand, Gujarat', lat: 22.5645, lng: 72.9289, status: 'Verified', timestamp: new Date().toISOString(), type: 'Cattle', workerId: 'initial' },
                            { animalId: '#Cattle-LOWCONF', breed: 'Sahiwal', confidence: 45.0, location: 'Ludhiana, Punjab', lat: 30.9010, lng: 75.8573, status: 'Pending', timestamp: new Date().toISOString(), type: 'Cattle', workerId: 'initial' },
                            { animalId: '#Buffalo-92C4F', breed: 'Murrah', confidence: 95.1, location: 'Rohtak, Haryana', lat: 28.8955, lng: 76.6066, status: 'Verified', timestamp: new Date().toISOString(), type: 'Buffalo', workerId: 'initial' }
                        ];
                         initialRegs.forEach(reg => {
                            const newKey = push(ref(db, regsRefPath)).key;
                            updates[`${regsRefPath}/${newKey}`] = reg;
                        });
                    }
                    if (Object.keys(updates).length > 0) {
                       await update(ref(db), updates);
                    }
                } catch(err) {
                    console.error("Seeding error: ", err);
                } finally {
                    seeding[type] = false;
                }
            }

            // --- Initialize all application components ---
            initAllDropdowns();
            const viewObserver = new MutationObserver((mutations) => {
                for (let mutation of mutations) {
                    if (mutation.attributeName === 'class' && !mutation.target.classList.contains('hidden')) {
                        const viewId = mutation.target.id;
                        if (viewId === 'dashboard-view') {
                            initDashboard();
                            setTimeout(() => { if (map) map.invalidateSize(); }, 150);
                        }
                        if (viewId === 'geospatial-view') {
                            initGeospatialView();
                            setTimeout(() => { if (geospatialMap) geospatialMap.invalidateSize(); }, 150);
                        }
                        if (viewId === 'reports-view') initReportsView();
                        if (viewId === 'workers-view') initWorkersView();
                    }
                }
            });

            views.forEach(view => viewObserver.observe(view, { attributes: true }));

            // Initial trigger
            const currentHash = window.location.hash || '#dashboard';
            switchView(currentHash);
            if(currentHash === '#dashboard') initDashboard();
            if(currentHash === '#geospatial') initGeospatialView();
            if(currentHash === '#reports') initReportsView();
            if(currentHash === '#workers') initWorkersView();
        });
    </script>

</body>
</html>

